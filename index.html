<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>إدارة قيود البنوك</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
    <script>
      // Check if fonts are loaded
      document.fonts.ready.then(() => {
        console.log('Fonts loaded successfully');
      }).catch(() => {
        console.warn('Fonts failed to load, using system fonts');
        // Fallback to system fonts
        document.body.style.fontFamily = 'Arial, sans-serif';
      });
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Check if Tailwind is loaded
      if (typeof tailwind === 'undefined') {
        console.error('Tailwind CSS failed to load!');
        // Add basic CSS fallback
        const style = document.createElement('style');
        style.textContent = `
          .bg-primary { background-color: #2563eb !important; }
          .bg-primary-hover { background-color: #1e4fd6 !important; }
          .text-white { color: white !important; }
          .border-border { border-color: #e5e7eb !important; }
          .bg-white { background-color: white !important; }
          .hidden { display: none !important; }
          .flex { display: flex !important; }
          .grid { display: grid !important; }
          .rounded-md { border-radius: 0.375rem !important; }
          .px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
          .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
        `;
        document.head.appendChild(style);
      }
      
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#2563eb', hover: '#1e4fd6' },
              bg: '#f7f9fc',
              border: '#e5e7eb',
              text: '#0f172a'
            },
            fontFamily: {
              sans: ['Cairo','Tajawal','ui-sans-serif','system-ui']
            }
          }
        }
      }
    </script>

    <!-- Day.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script>
      // Check if dayjs is loaded
      if (typeof dayjs === 'undefined') {
        console.error('Day.js failed to load!');
        // Fallback to basic date functions
        window.dayjs = {
          format: () => new Date().toISOString().split('T')[0],
          month: () => new Date().getMonth(),
          year: () => new Date().getFullYear(),
          extend: () => {},
          subtract: () => ({ format: () => new Date().toISOString().split('T')[0] }),
          endOf: () => ({ format: () => new Date().toISOString().split('T')[0] })
        };
      }
    </script>

    <!-- ExcelJS + FileSaver for styled Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
      // Check if ExcelJS is loaded
      if (typeof ExcelJS === 'undefined') {
        console.error('ExcelJS failed to load!');
        window.ExcelJS = { Workbook: class {} };
      }
      
      // Check if FileSaver is loaded
      if (typeof saveAs === 'undefined') {
        console.error('FileSaver failed to load!');
        window.saveAs = (blob, filename) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        };
      }
    </script>

    <style>
      html, body { height: 100%; }
      body { background: #f7f9fc; color: #0f172a; font-family: Cairo, Tajawal, ui-sans-serif, system-ui; }
      @media print {
        @page { size: A4 landscape; margin: 12mm; }
        .no-print { display: none !important; }
        thead { display: table-header-group; }
      }
      ::-webkit-scrollbar { width: 10px; height: 10px; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header / Navbar -->
    <header class="no-print bg-white shadow-sm border-b border-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-lg">₪</div>
                <h1 class="text-xl font-semibold">إدارة قيود البنوك</h1>
            </div>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
                <label for="bankSelect" class="text-sm text-slate-600">اختر البنك</label>
                <select id="bankSelect" class="px-3 py-2 border border-border rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                </select>
                <button id="addBankBtn" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-primary-hover text-sm">+ إضافة بنك</button>
            </div>
        </div>
        <nav class="bg-white border-t border-border">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex flex-wrap gap-2">
                <button data-nav="home" class="nav-btn px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">الرئيسية</button>
                <button data-nav="debit" class="nav-btn px-4 py-2 rounded-md bg-primary text-white hover:bg-primary-hover">➕ إضافة تسوية (مدين)</button>
                <button data-nav="credit" class="nav-btn px-4 py-2 rounded-md bg-primary text-white hover:bg-primary-hover">📄 إضافة مستند (دائن)</button>
                <button data-nav="monthly" class="nav-btn px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">📊 التقرير الشهري</button>
                <button data-nav="annual" class="nav-btn px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">📊 التقرير السنوي</button>
                <div class="flex-1"></div>
                <button onclick="window.print()" class="px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">🖨️ طباعة</button>
            </div>
        </nav>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

        <!-- Home Section -->
        <section data-section="home" class="section">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6">
                <h2 class="text-lg font-semibold mb-2">مرحبًا بك</h2>
                <p class="text-slate-600 mb-4">استخدم الأزرار أعلاه للتنقل بين إدخال القيود وعرض التقارير.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <button data-nav="debit" class="px-4 py-6 rounded-xl bg-primary text-white hover:bg-primary-hover text-center">➕ تسوية (مدين)</button>
                    <button data-nav="credit" class="px-4 py-6 rounded-xl bg-primary text-white hover:bg-primary-hover text-center">📄 مستند (دائن)</button>
                    <button data-nav="monthly" class="px-4 py-6 rounded-xl bg-white border border-border hover:bg-slate-50 text-center">📊 التقرير الشهري</button>
                    <button data-nav="annual" class="px-4 py-6 rounded-xl bg-white border border-border hover:bg-slate-50 text-center">📊 التقرير السنوي</button>
                </div>
            </div>
        </section>

        <!-- Debit Section -->
        <section data-section="debit" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <h2 class="text-lg font-semibold">شاشة المدين</h2>
                
                <!-- Form -->
                <form id="debitForm" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">التاريخ</label>
                        <input type="date" id="debitDate" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">البيان</label>
                        <input type="text" id="debitDesc" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">المبلغ</label>
                        <input type="number" id="debitAmount" step="0.01" min="0" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">ملاحظات</label>
                        <input type="text" id="debitNotes" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-5">
                        <button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">حفظ القيد</button>
                    </div>
                </form>

                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">بحث بالبيان</label>
                        <input type="text" id="debitSearch" class="w-full px-3 py-2 border border-border rounded-md" placeholder="اكتب نص البحث" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">من تاريخ</label>
                        <input type="date" id="debitFrom" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">إلى تاريخ</label>
                        <input type="date" id="debitTo" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="flex gap-2">
                        <button id="debitFilterBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">تصفية</button>
                        <button id="debitClearBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">مسح</button>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-auto">
                    <table class="min-w-full border border-border rounded-md">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 border border-border text-right">البيان</th>
                                <th class="px-3 py-2 border border-border text-center">التاريخ</th>
                                <th class="px-3 py-2 border border-border text-right">المبلغ</th>
                                <th class="px-3 py-2 border border-border text-right">ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody id="debitTableBody"></tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td class="px-3 py-2 border border-border" colspan="2">المجموع</td>
                                <td class="px-3 py-2 border border-border text-right" id="debitTotal">0.00</td>
                                <td class="px-3 py-2 border border-border"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Daily Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">التسوية اليومية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">تاريخ اليوم</label>
                            <input type="date" id="debitRecDate" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">رصيد كشف البنك</label>
                            <input type="number" id="debitBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">إجمالي قيود اليوم (مدين)</label>
                            <input type="text" id="debitDayTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="debitMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">مطابقة يومية</button>
                            <span id="debitMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">التسوية الشهرية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">الشهر</label>
                            <select id="debitMonthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                                <option value="1">يناير</option>
                                <option value="2">فبراير</option>
                                <option value="3">مارس</option>
                                <option value="4">أبريل</option>
                                <option value="5">مايو</option>
                                <option value="6">يونيو</option>
                                <option value="7">يوليو</option>
                                <option value="8">أغسطس</option>
                                <option value="9">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">السنة</label>
                            <input type="number" id="debitYearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">رصيد كشف البنك</label>
                            <input type="number" id="debitMonthBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">إجمالي الشهر (مدين)</label>
                            <input type="text" id="debitMonthTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="debitMonthMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">مطابقة شهرية</button>
                            <span id="debitMonthMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Credit Section -->
        <section data-section="credit" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <h2 class="text-lg font-semibold">شاشة الدائن</h2>
                
                <!-- Form -->
                <form id="creditForm" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">التاريخ</label>
                        <input type="date" id="creditDate" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">البيان</label>
                        <input type="text" id="creditDesc" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">المبلغ</label>
                        <input type="number" id="creditAmount" step="0.01" min="0" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">ملاحظات</label>
                        <input type="text" id="creditNotes" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-5">
                        <button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">حفظ القيد</button>
                    </div>
                </form>

                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">بحث بالبيان</label>
                        <input type="text" id="creditSearch" class="w-full px-3 py-2 border border-border rounded-md" placeholder="اكتب نص البحث" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">من تاريخ</label>
                        <input type="date" id="creditFrom" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">إلى تاريخ</label>
                        <input type="date" id="creditTo" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="flex gap-2">
                        <button id="creditFilterBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">تصفية</button>
                        <button id="creditClearBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">مسح</button>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-auto">
                    <table class="min-w-full border border-border rounded-md">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 border border-border text-right">البيان</th>
                                <th class="px-3 py-2 border border-border text-center">التاريخ</th>
                                <th class="px-3 py-2 border border-border text-right">المبلغ</th>
                                <th class="px-3 py-2 border border-border text-right">ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody id="creditTableBody"></tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td class="px-3 py-2 border border-border" colspan="2">المجموع</td>
                                <td class="px-3 py-2 border border-border text-right" id="creditTotal">0.00</td>
                                <td class="px-3 py-2 border border-border"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Daily Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">التسوية اليومية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">تاريخ اليوم</label>
                            <input type="date" id="creditRecDate" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">رصيد كشف البنك</label>
                            <input type="number" id="creditBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">إجمالي قيود اليوم (دائن)</label>
                            <input type="text" id="creditDayTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="creditMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">مطابقة يومية</button>
                            <span id="creditMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">التسوية الشهرية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">الشهر</label>
                            <select id="creditMonthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                                <option value="1">يناير</option>
                                <option value="2">فبراير</option>
                                <option value="3">مارس</option>
                                <option value="4">أبريل</option>
                                <option value="5">مايو</option>
                                <option value="6">يونيو</option>
                                <option value="7">يوليو</option>
                                <option value="8">أغسطس</option>
                                <option value="9">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">السنة</label>
                            <input type="number" id="creditYearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">رصيد كشف البنك</label>
                            <input type="number" id="creditMonthBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">إجمالي الشهر (دائن)</label>
                            <input type="text" id="creditMonthTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="creditMonthMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">مطابقة شهرية</button>
                            <span id="creditMonthMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Monthly Report Section (LTR) -->
        <section data-section="monthly" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <h2 class="text-lg font-semibold">التقرير الشهري</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">الشهر</label>
                        <select id="monthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                            <option value="1">يناير</option>
                            <option value="2">فبراير</option>
                            <option value="3">مارس</option>
                            <option value="4">أبريل</option>
                            <option value="5">مايو</option>
                            <option value="6">يونيو</option>
                            <option value="7">يوليو</option>
                            <option value="8">أغسطس</option>
                            <option value="9">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">السنة</label>
                        <input type="number" id="yearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                    </div>
                    <div class="flex gap-2 md:col-span-3">
                        <button id="monthlyRunBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">عرض التقرير</button>
                        <button id="monthlyExportBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">📤 تصدير Excel</button>
                    </div>
                </div>

                <div class="overflow-auto">
                    <div class="direction-ltr" style="direction: ltr;">
                        <table class="min-w-full border border-border rounded-md">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-3 py-2 border border-border">Month</th>
                                    <th class="px-3 py-2 border border-border">Opening Balance</th>
                                    <th class="px-3 py-2 border border-border">Total Debit</th>
                                    <th class="px-3 py-2 border border-border">Total Credit</th>
                                    <th class="px-3 py-2 border border-border">Net Movement</th>
                                    <th class="px-3 py-2 border border-border">Closing Balance</th>
                                    <th class="px-3 py-2 border border-border">Entries Count</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyTbody"></tbody>
                            <tfoot class="bg-slate-50 font-semibold">
                                <tr>
                                    <td class="px-3 py-2 border border-border">Totals</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyOpenTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyDebitTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyCreditTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyNetTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyCloseTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="monthlyCountTotal">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Annual Report Section (LTR) -->
        <section data-section="annual" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <h2 class="text-lg font-semibold">التقرير السنوي (السنة المالية 1/7 – 30/6)</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">بداية السنة المالية (YYYY)</label>
                        <input type="number" id="fiscalStartYear" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                    </div>
                    <div class="flex gap-2 md:col-span-3">
                        <button id="annualRunBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">عرض التقرير</button>
                        <button id="annualExportBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">📤 تصدير Excel</button>
                    </div>
                </div>

                <div class="overflow-auto">
                    <div class="direction-ltr" style="direction: ltr;">
                        <table class="min-w-full border border-border rounded-md">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-3 py-2 border border-border">Month</th>
                                    <th class="px-3 py-2 border border-border">Opening Balance</th>
                                    <th class="px-3 py-2 border border-border">Total Debit</th>
                                    <th class="px-3 py-2 border border-border">Total Credit</th>
                                    <th class="px-3 py-2 border border-border">Net Movement</th>
                                    <th class="px-3 py-2 border border-border">Closing Balance</th>
                                </tr>
                            </thead>
                            <tbody id="annualTbody"></tbody>
                            <tfoot class="bg-slate-50 font-semibold">
                                <tr>
                                    <td class="px-3 py-2 border border-border">Totals</td>
                                    <td class="px-3 py-2 border border-border text-right" id="annualOpenTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="annualDebitTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="annualCreditTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="annualNetTotal">0.00</td>
                                    <td class="px-3 py-2 border border-border text-right" id="annualCloseTotal">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Add Bank Modal -->
    <div id="bankModal" class="no-print hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg border border-border w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">إضافة بنك جديد</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm mb-1">اسم البنك</label>
                    <input type="text" id="newBankName" class="w-full px-3 py-2 border border-border rounded-md" placeholder="اكتب اسم البنك" />
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button id="bankCancelBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">إلغاء</button>
                    <button id="bankSaveBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="no-print fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-md shadow-lg hidden"></div>

    <script>
    // ===============================
    // Utilities
    // ===============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const showToast = (msg) => {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 2000);
    }
    const formatAmount = (n) => (Number(n)||0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    const todayISO = () => dayjs().format('YYYY-MM-DD');

    function getMonthNameEn(m){
      return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1];
    }

    function monthStartISO(year, month){ return dayjs(`${year}-${String(month).padStart(2,'0')}-01`).format('YYYY-MM-DD'); }
    function monthEndISO(year, month){ return dayjs(monthStartISO(year,month)).endOf('month').format('YYYY-MM-DD'); }
    function dayBeforeISO(dateISO){ return dayjs(dateISO).subtract(1,'day').format('YYYY-MM-DD'); }

    // ===============================
    // Storage Setup (IndexedDB + localStorage fallback)
    // ===============================
    const DB_NAME = 'bankLedgerDB';
    const DB_VERSION = 1;
    let dbInstance = null;
    let useLocalStorage = false;

    function openDB(){
      return new Promise((resolve, reject)=>{
        if(dbInstance){ resolve(dbInstance); return; }
        
        // Check if IndexedDB is available
        if (!window.indexedDB) {
          console.log('IndexedDB not available, using localStorage');
          useLocalStorage = true;
          resolve('localStorage');
          return;
        }

        console.log('Opening IndexedDB...');
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => {
          console.error('IndexedDB error:', req.error);
          console.log('Falling back to localStorage');
          useLocalStorage = true;
          resolve('localStorage');
        };
        req.onupgradeneeded = (ev) => {
          console.log('Upgrading database...');
          const db = ev.target.result;
          // banks
          if(!db.objectStoreNames.contains('banks')){
            const s = db.createObjectStore('banks', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_name', 'name', { unique: true });
            console.log('Created banks store');
          }
          // entries
          if(!db.objectStoreNames.contains('entries')){
            const s = db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_bankId', 'bankId');
            s.createIndex('by_bankId_type_date', ['bankId','type','dateISO']);
            s.createIndex('by_bankId_date', ['bankId','dateISO']);
            console.log('Created entries store');
          }
          // reconciliations
          if(!db.objectStoreNames.contains('reconciliations')){
            const s = db.createObjectStore('reconciliations', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_bankId_date', ['bankId','dateISO'], { unique: true });
            console.log('Created reconciliations store');
          }
        };
        req.onsuccess = async () => {
          console.log('IndexedDB opened successfully');
          dbInstance = req.result;
          dbInstance.onversionchange = () => dbInstance.close();
          resolve(dbInstance);
        }
      });
    }

    function tx(storeNames, mode='readonly'){
      if (useLocalStorage) return Promise.resolve('localStorage');
      return openDB().then(db => db.transaction(storeNames, mode));
    }

    // Banks
    async function addBank(name){
      if (useLocalStorage) {
        const banks = JSON.parse(localStorage.getItem('banks') || '[]');
        const newBank = { id: Date.now(), name, createdAt: new Date().toISOString() };
        banks.push(newBank);
        localStorage.setItem('banks', JSON.stringify(banks));
        return newBank.id;
      }
      
      const t = await tx(['banks'], 'readwrite');
      const s = t.objectStore('banks');
      return new Promise((resolve, reject)=>{
        const req = s.add({ name, createdAt: new Date().toISOString() });
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function listBanks(){
      if (useLocalStorage) {
        const banks = JSON.parse(localStorage.getItem('banks') || '[]');
        return banks;
      }
      
      const t = await tx(['banks']);
      const s = t.objectStore('banks');
      return new Promise((resolve, reject)=>{
        const req = s.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    // Entries
    async function addEntry(entry){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        const newEntry = { id: Date.now(), ...entry, createdAt: new Date().toISOString() };
        entries.push(newEntry);
        localStorage.setItem('entries', JSON.stringify(entries));
        return newEntry.id;
      }
      
      const t = await tx(['entries'], 'readwrite');
      const s = t.objectStore('entries');
      return new Promise((resolve, reject)=>{
        const req = s.add({ ...entry, createdAt: new Date().toISOString() });
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function listEntriesByBankAndFilters(bankId, type, {searchText='', fromDateISO='', toDateISO=''}={}){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        let results = entries.filter(e => e.bankId === bankId && e.type === type);
        
        // Filter by date range
        if (fromDateISO) {
          results = results.filter(e => e.dateISO >= fromDateISO);
        }
        if (toDateISO) {
          results = results.filter(e => e.dateISO <= toDateISO);
        }
        
        // Filter by search text
        if (searchText) {
          results = results.filter(e => (e.description || '').includes(searchText));
        }
        
        return results;
      }
      
      const t = await tx(['entries']);
      const s = t.objectStore('entries');
      const idx = s.index('by_bankId_type_date');
      const lower = [bankId, type, fromDateISO || '0000-01-01'];
      const upper = [bankId, type, toDateISO || '9999-12-31'];
      const range = IDBKeyRange.bound(lower, upper);
      return new Promise((resolve, reject)=>{
        const results = [];
        const req = idx.openCursor(range);
        req.onsuccess = (ev) => {
          const cursor = ev.target.result;
          if(cursor){
            const v = cursor.value;
            if(!searchText || (v.description||'').includes(searchText)){
              results.push(v);
            }
            cursor.continue();
          } else {
            resolve(results);
          }
        }
        req.onerror = () => reject(req.error);
      });
    }

    async function sumEntries(bankId, type, fromISO, toISO){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        let results = entries.filter(e => e.bankId === bankId && e.type === type);
        
        // Filter by date range
        if (fromISO) {
          results = results.filter(e => e.dateISO >= fromISO);
        }
        if (toISO) {
          results = results.filter(e => e.dateISO <= toISO);
        }
        
        return results.reduce((acc, r)=> acc + Number(r.amount||0), 0);
      }
      
      const rows = await listEntriesByBankAndFilters(bankId, type, { fromDateISO: fromISO, toDateISO: toISO });
      return rows.reduce((acc, r)=> acc + Number(r.amount||0), 0);
    }

    // Reconciliations
    async function upsertReconciliation(bankId, dateISO, bankStatementBalance){
      if (useLocalStorage) {
        const reconciliations = JSON.parse(localStorage.getItem('reconciliations') || '[]');
        const existingIndex = reconciliations.findIndex(r => r.bankId === bankId && r.dateISO === dateISO);
        
        if (existingIndex >= 0) {
          reconciliations[existingIndex].bankStatementBalance = bankStatementBalance;
        } else {
          reconciliations.push({ id: Date.now(), bankId, dateISO, bankStatementBalance });
        }
        
        localStorage.setItem('reconciliations', JSON.stringify(reconciliations));
        return true;
      }
      
      const t = await tx(['reconciliations'], 'readwrite');
      const s = t.objectStore('reconciliations');
      const idx = s.index('by_bankId_date');
      return new Promise((resolve, reject)=>{
        const getReq = idx.get([bankId, dateISO]);
        getReq.onsuccess = () => {
          const existing = getReq.result;
          if(existing){
            const putReq = s.put({ ...existing, bankStatementBalance });
            putReq.onsuccess = () => resolve(putReq.result);
            putReq.onerror = () => reject(putReq.error);
          } else {
            const addReq = s.add({ bankId, dateISO, bankStatementBalance });
            addReq.onsuccess = () => resolve(addReq.result);
            addReq.onerror = () => reject(addReq.error);
          }
        }
        getReq.onerror = () => reject(getReq.error);
      });
    }

    async function getReconciliation(bankId, dateISO){
      if (useLocalStorage) {
        const reconciliations = JSON.parse(localStorage.getItem('reconciliations') || '[]');
        return reconciliations.find(r => r.bankId === bankId && r.dateISO === dateISO) || null;
      }
      
      const t = await tx(['reconciliations']);
      const s = t.objectStore('reconciliations');
      const idx = s.index('by_bankId_date');
      return new Promise((resolve, reject)=>{
        const req = idx.get([bankId, dateISO]);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    // Balances and aggregates
    async function computeOpeningBalance(bankId, startDateExclusiveISO){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        const dayBefore = dayBeforeISO(startDateExclusiveISO);
        
        const debit = entries
          .filter(e => e.bankId === bankId && e.type === 'debit' && e.dateISO < startDateExclusiveISO)
          .reduce((sum, e) => sum + Number(e.amount || 0), 0);
          
        const credit = entries
          .filter(e => e.bankId === bankId && e.type === 'credit' && e.dateISO < startDateExclusiveISO)
          .reduce((sum, e) => sum + Number(e.amount || 0), 0);
          
        return debit - credit;
      }
      
      const beforeFrom = '0000-01-01';
      const dayBefore = dayBeforeISO(startDateExclusiveISO);
      const debit = await sumEntries(bankId, 'debit', beforeFrom, dayBefore);
      const credit = await sumEntries(bankId, 'credit', beforeFrom, dayBefore);
      return debit - credit;
    }

    async function computeMonthlyAggregates(bankId, month, year){
      if (useLocalStorage) {
        const start = monthStartISO(year, month);
        const end = monthEndISO(year, month);
        const opening = await computeOpeningBalance(bankId, start);
        const totalDebit = await sumEntries(bankId, 'debit', start, end);
        const totalCredit = await sumEntries(bankId, 'credit', start, end);
        const net = totalDebit - totalCredit;
        const closing = opening + net;
        const debitEntries = await listEntriesByBankAndFilters(bankId, 'debit', { fromDateISO: start, toDateISO: end });
        const creditEntries = await listEntriesByBankAndFilters(bankId, 'credit', { fromDateISO: start, toDateISO: end });
        return { start, end, opening, totalDebit, totalCredit, net, closing, count: debitEntries.length + creditEntries.length, debitEntries, creditEntries };
      }
      
      const start = monthStartISO(year, month);
      const end = monthEndISO(year, month);
      const opening = await computeOpeningBalance(bankId, start);
      const totalDebit = await sumEntries(bankId, 'debit', start, end);
      const totalCredit = await sumEntries(bankId, 'credit', start, end);
      const net = totalDebit - totalCredit;
      const closing = opening + net;
      const debitEntries = await listEntriesByBankAndFilters(bankId, 'debit', { fromDateISO: start, toDateISO: end });
      const creditEntries = await listEntriesByBankAndFilters(bankId, 'credit', { fromDateISO: start, toDateISO: end });
      return { start, end, opening, totalDebit, totalCredit, net, closing, count: debitEntries.length + creditEntries.length, debitEntries, creditEntries };
    }

    async function computeFiscalYearAggregates(bankId, fiscalStartYear){
      if (useLocalStorage) {
        // months Jul..Dec of start year, then Jan..Jun of next year
        const months = [7,8,9,10,11,12,1,2,3,4,5,6];
        const rows = [];
        let y = fiscalStartYear;
        for(const m of months){
          const year = (m >= 7 ? fiscalStartYear : fiscalStartYear + 1);
          const agg = await computeMonthlyAggregates(bankId, m, year);
          rows.push({ month: m, year, ...agg });
        }
        return rows;
      }
      
      // months Jul..Dec of start year, then Jan..Jun of next year
      const months = [7,8,9,10,11,12,1,2,3,4,5,6];
      const rows = [];
      let y = fiscalStartYear;
      for(const m of months){
        const year = (m >= 7 ? fiscalStartYear : fiscalStartYear + 1);
        const agg = await computeMonthlyAggregates(bankId, m, year);
        rows.push({ month: m, year, ...agg });
      }
      return rows;
    }

    // ===============================
    // State
    // ===============================
    let currentBankId = null;
    let currentBankName = '';

    async function refreshBankSelector(){
      try {
        const banks = await listBanks();
        console.log('Banks loaded:', banks);
        const sel = $('#bankSelect');
        sel.innerHTML = '';
        
        // If no banks exist, create default bank only once
        if(banks.length === 0){
          console.log('No banks found, creating default bank...');
          await addBank('البنك الافتراضي');
          // Get the updated list
          const updatedBanks = await listBanks();
          banks.length = 0;
          banks.push(...updatedBanks);
        }
        
        for(const b of banks){
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.name;
          sel.appendChild(opt);
        }
        
        // Set current bank from localStorage if available
        const savedBankId = localStorage.getItem('currentBankId');
        const savedBankName = localStorage.getItem('currentBankName');
        console.log('Saved bank from localStorage:', { id: savedBankId, name: savedBankName });
        
        if(savedBankId && banks.find(b => b.id == savedBankId)){
          currentBankId = Number(savedBankId);
          currentBankName = savedBankName || banks.find(b => b.id == currentBankId)?.name;
          console.log('Restored bank from localStorage:', currentBankId, currentBankName);
        } else if(banks[0]){
          currentBankId = banks[0].id;
          currentBankName = banks[0].name;
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);
          console.log('Set default bank and saved to localStorage:', currentBankId, currentBankName);
        }
        
        if(currentBankId){ 
          sel.value = String(currentBankId);
          console.log('Bank selector set to:', currentBankId);
        }
        console.log('Bank selector refreshed, currentBankId:', currentBankId, 'currentBankName:', currentBankName);
      } catch (error) {
        console.error('Error refreshing bank selector:', error);
      }
    }

    function setSection(name){
      console.log('Setting section to:', name);
      $$('.section').forEach(sec=> sec.classList.add('hidden'));
      const targetSection = $(`section[data-section="${name}"]`);
      if (targetSection) {
        targetSection.classList.remove('hidden');
        // Save current section to localStorage
        localStorage.setItem('currentSection', name);
        console.log('Section shown:', name);
      } else {
        console.error('Section not found:', name);
      }
    }

    // ===============================
    // Rendering tables
    // ===============================
    function renderRows(tbody, rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 border border-border text-right">${escapeHtml(r.description||'')}</td>
          <td class="px-3 py-2 border border-border text-center">${r.dateISO}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.amount)}</td>
          <td class="px-3 py-2 border border-border text-right">${escapeHtml(r.notes||'')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    async function reloadEntries(type){
      try {
        const search = type==='debit' ? $('#debitSearch').value.trim() : $('#creditSearch').value.trim();
        const from = type==='debit' ? $('#debitFrom').value : $('#creditFrom').value;
        const to = type==='debit' ? $('#debitTo').value : $('#creditTo').value;
        const rows = await listEntriesByBankAndFilters(currentBankId, type, { searchText: search, fromDateISO: from||'0000-01-01', toDateISO: to||'9999-12-31' });
        const body = type==='debit' ? $('#debitTableBody') : $('#creditTableBody');
        renderRows(body, rows);
        const total = rows.reduce((a,r)=> a + Number(r.amount||0), 0);
        (type==='debit'? $('#debitTotal'): $('#creditTotal')).textContent = formatAmount(total);
        console.log(`Reloaded ${type} entries:`, rows.length, 'rows, total:', total);
      } catch (error) {
        console.error(`Error reloading ${type} entries:`, error);
      }
    }

    async function updateDailyTotals(type){
      try {
        const date = type==='debit' ? $('#debitRecDate').value : $('#creditRecDate').value;
        if(!date){ return; }
        const tot = await sumEntries(currentBankId, type, date, date);
        (type==='debit'? $('#debitDayTotal') : $('#creditDayTotal')).value = formatAmount(tot);
        console.log(`Updated daily totals for ${type}:`, tot);
      } catch (error) {
        console.error(`Error updating daily totals for ${type}:`, error);
      }
    }

    async function updateMonthlyTotals(type){
      try {
        const month = type==='debit' ? Number($('#debitMonthSelect').value) : Number($('#creditMonthSelect').value);
        const year = type==='debit' ? Number($('#debitYearInput').value) : Number($('#creditYearInput').value);
        
        console.log(`updateMonthlyTotals called for ${type}:`, { month, year, currentBankId });
        
        if(!month || !year){ 
          console.log(`Missing month or year for ${type}:`, { month, year });
          return; 
        }
        
        if(!currentBankId){
          console.log(`No currentBankId for ${type}`);
          return;
        }
        
        const tot = await sumEntries(currentBankId, type, monthStartISO(year, month), monthEndISO(year, month));
        (type==='debit'? $('#debitMonthTotal') : $('#creditMonthTotal')).value = formatAmount(tot);
        console.log(`Updated monthly totals for ${type}:`, tot);
      } catch (error) {
        console.error(`Error updating monthly totals for ${type}:`, error);
      }
    }

    // ===============================
    // Excel Export using ExcelJS
    // ===============================
    function addInfoHeader(ws, infoPairs){
      let rowIdx = 1;
      for(const [k,v] of infoPairs){
        const row = ws.getRow(rowIdx++);
        row.getCell(1).value = k;
        row.getCell(2).value = v;
        row.font = { bold: true };
      }
      ws.getColumn(1).width = 22;
      ws.getColumn(2).width = 40;
      return rowIdx;
    }

    function styleHeaderRow(row){
      row.eachCell(cell => {
        cell.fill = { type: 'pattern', pattern:'solid', fgColor: { argb: 'FFF1F5F9' } };
        cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
        cell.font = { bold: true };
        cell.alignment = { vertical:'middle', horizontal:'center' };
      });
    }

    function styleDataRow(row){
      row.eachCell(cell => {
        cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
        if(typeof cell.value === 'number'){
          cell.numFmt = '#,##0.00';
          cell.alignment = { horizontal:'right' };
        }
      });
    }

    async function exportMonthlyExcel(bankName, month, year, agg){
      const wb = new ExcelJS.Workbook();
      const mm = String(month).padStart(2,'0');
      // Debit sheet
      const wsD = wb.addWorksheet(`مدين - ${bankName} - ${mm}/${year}`);
      const infoStartRowD = addInfoHeader(wsD, [
        ['Bank', bankName],
        ['Month/Year', `${mm}/${year}`],
        ['Opening Balance', agg.opening],
        ['Total Debit', agg.totalDebit],
        ['Total Credit', agg.totalCredit],
        ['Net Movement', agg.net],
        ['Closing Balance', agg.closing]
      ]);
      let r = infoStartRowD + 1;
      const hdrD = wsD.getRow(r++);
      hdrD.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrD);
      for(const e of agg.debitEntries){
        const row = wsD.getRow(r++);
        row.values = [e.description, e.dateISO, Number(e.amount), e.notes||''];
        styleDataRow(row);
      }

      // Credit sheet
      const wsC = wb.addWorksheet(`دائن - ${bankName} - ${mm}/${year}`);
      const infoStartRowC = addInfoHeader(wsC, [
        ['Bank', bankName],
        ['Month/Year', `${mm}/${year}`],
        ['Opening Balance', agg.opening],
        ['Total Debit', agg.totalDebit],
        ['Total Credit', agg.totalCredit],
        ['Net Movement', agg.net],
        ['Closing Balance', agg.closing]
      ]);
      let rc = infoStartRowC + 1;
      const hdrC = wsC.getRow(rc++);
      hdrC.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrC);
      for(const e of agg.creditEntries){
        const row = wsC.getRow(rc++);
        row.values = [e.description, e.dateISO, Number(e.amount), e.notes||''];
        styleDataRow(row);
      }

      const fname = `${bankName} - تقرير شهري - ${mm}-${year}.xlsx`;
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fname);
    }

    async function exportAnnualExcel(bankName, fiscalStartYear, rows){
      const wb = new ExcelJS.Workbook();
      const period = `${fiscalStartYear}-${fiscalStartYear+1}`;

      // Flatten entries across months for each type
      const allDebit = [];
      const allCredit = [];
      for(const r of rows){
        for(const e of r.debitEntries){ allDebit.push(e); }
        for(const e of r.creditEntries){ allCredit.push(e); }
      }

      const wsD = wb.addWorksheet(`مدين - ${bankName} - ${period}`);
      addInfoHeader(wsD, [['Bank', bankName], ['Fiscal Year', period]]);
      let r1 = 3;
      const hdrD = wsD.getRow(r1++);
      hdrD.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrD);
      for(const e of allDebit){ const row = wsD.getRow(r1++); row.values = [e.description, e.dateISO, Number(e.amount), e.notes||'']; styleDataRow(row); }

      const wsC = wb.addWorksheet(`دائن - ${bankName} - ${period}`);
      addInfoHeader(wsC, [['Bank', bankName], ['Fiscal Year', period]]);
      let r2 = 3;
      const hdrC = wsC.getRow(r2++);
      hdrC.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrC);
      for(const e of allCredit){ const row = wsC.getRow(r2++); row.values = [e.description, e.dateISO, Number(e.amount), e.notes||'']; styleDataRow(row); }

      const fname = `${bankName} - تقرير سنوي - ${period}.xlsx`;
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fname);
    }

    // ===============================
    // Event handlers and init
    // ===============================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM loaded, starting initialization...');
      
      try {
        // Check if all required functions are available
        if (typeof dayjs === 'undefined') {
          throw new Error('Day.js library not loaded');
        }
        
        if (typeof $ === 'undefined') {
          throw new Error('jQuery-like functions not available');
        }
        
        await openDB();
        console.log('Database opened successfully');
        await refreshBankSelector();
        console.log('Bank selector refreshed');
        
        // default dates - restore from localStorage or use today
        const today = todayISO();
        const savedDebitDate = localStorage.getItem('debitDate') || today;
        const savedCreditDate = localStorage.getItem('creditDate') || today;
        const savedDebitRecDate = localStorage.getItem('debitRecDate') || today;
        const savedCreditRecDate = localStorage.getItem('creditRecDate') || today;
        
        $('#debitDate').value = savedDebitDate;
        $('#creditDate').value = savedCreditDate;
        $('#debitRecDate').value = savedDebitRecDate;
        $('#creditRecDate').value = savedCreditRecDate;
        
        console.log('Dates restored from localStorage:', {
          debitDate: savedDebitDate,
          creditDate: savedCreditDate,
          debitRecDate: savedDebitRecDate,
          creditRecDate: savedCreditRecDate
        });
        
        // Set current month/year for monthly reconciliation - restore from localStorage or use current
        const now = dayjs();
        const savedDebitMonth = localStorage.getItem('debitMonth') || String(now.month()+1);
        const savedDebitYear = localStorage.getItem('debitYear') || String(now.year());
        const savedCreditMonth = localStorage.getItem('creditMonth') || String(now.month()+1);
        const savedCreditYear = localStorage.getItem('creditYear') || String(now.year());
        
        $('#debitMonthSelect').value = savedDebitMonth;
        $('#debitYearInput').value = savedDebitYear;
        $('#creditMonthSelect').value = savedCreditMonth;
        $('#creditYearInput').value = savedCreditYear;
        
        console.log('Monthly reconciliation initialized with:', {
          month: now.month()+1,
          year: now.year()
        });

        // Navigation buttons
        $$('.nav-btn, [data-nav]').forEach(btn => btn.addEventListener('click', (e)=>{
          const target = e.currentTarget.getAttribute('data-nav');
          console.log('Navigation button clicked:', target);
          if(target){ 
            setSection(target);
            // Update button styles
            $$('.nav-btn').forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('border', 'border-border', 'bg-white');
            });
            e.currentTarget.classList.remove('border', 'border-border', 'bg-white');
            e.currentTarget.classList.add('bg-primary', 'text-white');
          }
        }));
        
        // Restore last section from localStorage
        const savedSection = localStorage.getItem('currentSection') || 'home';
        setSection(savedSection);
        console.log('Restored section:', savedSection);
        
        // Update button styles for restored section
        setTimeout(() => {
          const activeButton = $(`[data-nav="${savedSection}"]`);
          if(activeButton) {
            $$('.nav-btn').forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('border', 'border-border', 'bg-white');
            });
            activeButton.classList.remove('border', 'border-border', 'bg-white');
            activeButton.classList.add('bg-primary', 'text-white');
          }
        }, 100);
        
        // Load data for current bank if available
        if (currentBankId) {
          console.log('Loading data for current bank:', currentBankId);
          setTimeout(async () => {
            try {
              // Clear existing data first
              $('#debitTableBody').innerHTML = '';
              $('#creditTableBody').innerHTML = '';
              $('#debitTotal').textContent = '0.00';
              $('#creditTotal').textContent = '0.00';
              
              await reloadEntries('debit');
              await reloadEntries('credit');
              await updateDailyTotals('debit');
              await updateDailyTotals('credit');
              await updateMonthlyTotals('debit');
              await updateMonthlyTotals('credit');
              console.log('Data loaded successfully for bank:', currentBankId);
            } catch (error) {
              console.error('Error loading data for bank:', error);
            }
          }, 200);
        }
        
        console.log('Initialization completed successfully');
      } catch (error) {
        console.error('Error during initialization:', error);
        // Show error to user
        showToast('خطأ في تهيئة البرنامج: ' + error.message);
        
        // Try to show basic functionality
        try {
          setSection('home');
          console.log('Basic functionality enabled despite errors');
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
        }
      }

      // Bank selector
      $('#bankSelect').addEventListener('change', async (e)=>{
        try {
          currentBankId = Number(e.target.value);
          const banks = await listBanks();
          currentBankName = (banks.find(b=>b.id===currentBankId)||{}).name || '';
          
          // Save selected bank to localStorage
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);
          
          console.log('Bank changed to:', currentBankId, currentBankName);
          
          // Clear existing data first
          $('#debitTableBody').innerHTML = '';
          $('#creditTableBody').innerHTML = '';
          $('#debitTotal').textContent = '0.00';
          $('#creditTotal').textContent = '0.00';
          
          // Load new data for selected bank
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');
          
          console.log('Data reloaded for bank:', currentBankId);
          
          // Show success message
          showToast(`تم تحميل بيانات البنك: ${currentBankName}`);
          
        } catch (error) {
          console.error('Error changing bank:', error);
          showToast('خطأ في تغيير البنك: ' + error.message);
        }
      });

      // Add Bank modal
      $('#addBankBtn').addEventListener('click', ()=>{ $('#newBankName').value=''; $('#bankModal').classList.remove('hidden'); $('#bankModal').classList.add('flex'); });
      $('#bankCancelBtn').addEventListener('click', ()=>{ $('#bankModal').classList.add('hidden'); $('#bankModal').classList.remove('flex'); });
      $('#bankSaveBtn').addEventListener('click', async ()=>{
        const name = $('#newBankName').value.trim();
        if(!name){ showToast('من فضلك أدخل اسم البنك'); return; }
        try{
          console.log('Adding new bank:', name);
          const id = await addBank(name);
          console.log('Bank added with ID:', id);
          await refreshBankSelector();
          $('#bankSelect').value = String(id);
          currentBankId = id; currentBankName = name;
          
          // Save new bank to localStorage
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);
          
          $('#bankModal').classList.add('hidden'); $('#bankModal').classList.remove('flex');
          showToast('تم إضافة البنك');
          
          // Clear existing data and load for new bank
          $('#debitTableBody').innerHTML = '';
          $('#creditTableBody').innerHTML = '';
          $('#debitTotal').textContent = '0.00';
          $('#creditTotal').textContent = '0.00';
          
          // Reload entries for the new bank
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');
        }catch(err){ 
          console.error('Error adding bank:', err);
          showToast('خطأ في إضافة البنك: ' + err.message); 
        }
      });

      // Debit form
      $('#debitForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const description = $('#debitDesc').value.trim();
        const dateISO = $('#debitDate').value;
        const amount = Number($('#debitAmount').value);
        const notes = $('#debitNotes').value.trim();
        if(!description || !dateISO || !(amount>0)){ showToast('تأكد من إدخال البيانات'); return; }
        
        try {
          console.log('Adding debit entry:', { bankId: currentBankId, type: 'debit', description, dateISO, amount, notes });
          await addEntry({ bankId: currentBankId, type: 'debit', description, dateISO, amount, notes });
          showToast('تم حفظ القيد (مدين)');
          $('#debitForm').reset(); $('#debitDate').value = today;
          await reloadEntries('debit');
          await updateDailyTotals('debit');
          await updateMonthlyTotals('debit');
          console.log('Debit entry added successfully');
        } catch (error) {
          console.error('Error adding debit entry:', error);
          showToast('خطأ في حفظ القيد: ' + error.message);
        }
      });

      // Credit form
      $('#creditForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const description = $('#creditDesc').value.trim();
        const dateISO = $('#creditDate').value;
        const amount = Number($('#creditAmount').value);
        const notes = $('#creditNotes').value.trim();
        if(!description || !dateISO || !(amount>0)){ showToast('تأكد من إدخال البيانات'); return; }
        
        try {
          console.log('Adding credit entry:', { bankId: currentBankId, type: 'credit', description, dateISO, amount, notes });
          await addEntry({ bankId: currentBankId, type: 'credit', description, dateISO, amount, notes });
          showToast('تم حفظ القيد (دائن)');
          $('#creditForm').reset(); $('#creditDate').value = today;
          await reloadEntries('credit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('credit');
          console.log('Credit entry added successfully');
        } catch (error) {
          console.error('Error adding credit entry:', error);
          showToast('خطأ في حفظ القيد: ' + error.message);
        }
      });

      // Filters
      $('#debitFilterBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await reloadEntries('debit'); });
      $('#debitClearBtn').addEventListener('click', async (e)=>{ e.preventDefault(); $('#debitSearch').value=''; $('#debitFrom').value=''; $('#debitTo').value=''; await reloadEntries('debit'); });
      $('#creditFilterBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await reloadEntries('credit'); });
      $('#creditClearBtn').addEventListener('click', async (e)=>{ e.preventDefault(); $('#creditSearch').value=''; $('#creditFrom').value=''; $('#creditTo').value=''; await reloadEntries('credit'); });

      // Auto-update date fields when form dates change
      $('#debitDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#debitRecDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('debitDate', e.target.value);
          localStorage.setItem('debitRecDate', e.target.value);
          updateDailyTotals('debit');
          updateMonthlyTotals('debit');
        }
      });
      
      $('#creditDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#creditRecDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('creditDate', e.target.value);
          localStorage.setItem('creditRecDate', e.target.value);
          updateDailyTotals('credit');
          updateMonthlyTotals('credit');
        }
      });

      // Daily reconciliation - Initialize default values
      $('#debitRecDate').value = today;
      $('#creditRecDate').value = today;
      
      // Initialize daily totals after setting values
      setTimeout(() => {
        if (currentBankId) {
          updateDailyTotals('debit');
          updateDailyTotals('credit');
        }
      }, 100);
      
      // Daily reconciliation event listeners
      $('#debitRecDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#debitDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('debitRecDate', e.target.value);
          localStorage.setItem('debitDate', e.target.value);
          if (currentBankId) {
            updateDailyTotals('debit');
            updateMonthlyTotals('debit');
          }
        }
      });
      $('#creditRecDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#creditDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('creditRecDate', e.target.value);
          localStorage.setItem('creditDate', e.target.value);
          if (currentBankId) {
            updateDailyTotals('credit');
            updateMonthlyTotals('credit');
          }
        }
      });

      $('#debitMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('من فضلك اختر بنك أولاً');
            return;
          }
          
          const date = $('#debitRecDate').value;
          const bal = Number($('#debitBankBalance').value);
          
          if (!date) {
            showToast('من فضلك اختر التاريخ');
            return;
          }
          
          if (!bal || bal <= 0) {
            showToast('من فضلك أدخل رصيد كشف البنك');
            return;
          }
          
          console.log('Daily reconciliation for debit:', { date, balance: bal, currentBankId });
          
          // Calculate daily total
          const total = await sumEntries(currentBankId, 'debit', date, date);
          $('#debitDayTotal').value = formatAmount(total);
          
          // Calculate difference
          const diff = bal - total;
          $('#debitMatchResult').textContent = diff === 0 ? '✅ متطابق' : `❌ الفرق: ${formatAmount(diff)}`;
          
          // Save reconciliation
          await upsertReconciliation(currentBankId, date, bal);
          console.log('Daily reconciliation saved for debit');
          
          showToast('تم حفظ التسوية اليومية');
          
        } catch (error) {
          console.error('Error in daily reconciliation for debit:', error);
          showToast('خطأ في التسوية اليومية: ' + error.message);
        }
      });

      $('#creditMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('من فضلك اختر بنك أولاً');
            return;
          }
          
          const date = $('#creditRecDate').value;
          const bal = Number($('#creditBankBalance').value);
          
          if (!date) {
            showToast('من فضلك اختر التاريخ');
            return;
          }
          
          if (!bal || bal <= 0) {
            showToast('من فضلك أدخل رصيد كشف البنك');
            return;
          }
          
          console.log('Daily reconciliation for credit:', { date, balance: bal, currentBankId });
          
          // Calculate daily total
          const total = await sumEntries(currentBankId, 'credit', date, date);
          $('#creditDayTotal').value = formatAmount(total);
          
          // Calculate difference
          const diff = bal - total;
          $('#creditMatchResult').textContent = diff === 0 ? '✅ متطابق' : `❌ الفرق: ${formatAmount(diff)}`;
          
          // Save reconciliation
          await upsertReconciliation(currentBankId, date, bal);
          console.log('Daily reconciliation saved for credit');
          
          showToast('تم حفظ التسوية اليومية');
          
        } catch (error) {
          console.error('Error in daily reconciliation for credit:', error);
          showToast('خطأ في التسوية اليومية: ' + error.message);
        }
      });

      // Monthly reconciliation - Initialize default values
      const now = dayjs();
      $('#debitMonthSelect').value = String(now.month() + 1);
      $('#debitYearInput').value = String(now.year());
      $('#creditMonthSelect').value = String(now.month() + 1);
      $('#creditYearInput').value = String(now.year());
      
      // Initialize monthly totals after setting values
      setTimeout(() => {
        updateMonthlyTotals('debit');
        updateMonthlyTotals('credit');
      }, 100);
      
      // Monthly reconciliation event listeners
      $('#debitMonthSelect').addEventListener('change', (e)=>{
        localStorage.setItem('debitMonth', e.target.value);
        updateMonthlyTotals('debit');
      });
      $('#debitYearInput').addEventListener('change', (e)=>{
        localStorage.setItem('debitYear', e.target.value);
        updateMonthlyTotals('debit');
      });
      $('#creditMonthSelect').addEventListener('change', (e)=>{
        localStorage.setItem('creditMonth', e.target.value);
        updateMonthlyTotals('credit');
      });
      $('#creditYearInput').addEventListener('change', (e)=>{
        localStorage.setItem('creditYear', e.target.value);
        updateMonthlyTotals('credit');
      });
      
      // Auto-update date fields when monthly reconciliation changes
      $('#debitMonthSelect, #debitYearInput').forEach(el => el.addEventListener('change', ()=>{
        const month = Number($('#debitMonthSelect').value);
        const year = Number($('#debitYearInput').value);
        if(month && year) {
          const newDate = monthStartISO(year, month);
          $('#debitDate').value = newDate;
          $('#debitRecDate').value = newDate;
          // Save date to localStorage
          localStorage.setItem('debitDate', newDate);
          localStorage.setItem('debitRecDate', newDate);
          updateMonthlyTotals('debit');
          updateDailyTotals('debit');
        }
      }));
      
      $('#creditMonthSelect, #creditYearInput').forEach(el => el.addEventListener('change', ()=>{
        const month = Number($('#creditMonthSelect').value);
        const year = Number($('#creditYearInput').value);
        if(month && year) {
          const newDate = monthStartISO(year, month);
          $('#creditDate').value = newDate;
          $('#creditRecDate').value = newDate;
          // Save date to localStorage
          localStorage.setItem('creditDate', newDate);
          localStorage.setItem('creditRecDate', newDate);
          updateMonthlyTotals('credit');
          updateDailyTotals('credit');
        }
      }));

      $('#debitMonthMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('من فضلك اختر بنك أولاً');
            return;
          }
          
          const month = Number($('#debitMonthSelect').value);
          const year = Number($('#debitYearInput').value);
          const bal = Number($('#debitMonthBankBalance').value);
          
          if (!month || !year) {
            showToast('من فضلك اختر الشهر والسنة');
            return;
          }
          
          if (!bal || bal <= 0) {
            showToast('من فضلك أدخل رصيد كشف البنك');
            return;
          }
          
          console.log('Monthly reconciliation for debit:', { month, year, balance: bal, currentBankId });
          
          // Calculate monthly total
          const total = await sumEntries(currentBankId, 'debit', monthStartISO(year, month), monthEndISO(year, month));
          $('#debitMonthTotal').value = formatAmount(total);
          
          // Calculate difference
          const diff = bal - total;
          $('#debitMonthMatchResult').textContent = diff === 0 ? '✅ متطابق' : `❌ الفرق: ${formatAmount(diff)}`;
          
          // Save monthly reconciliation
          const monthEnd = monthEndISO(year, month);
          await upsertReconciliation(currentBankId, monthEnd, bal);
          console.log('Monthly reconciliation saved for debit');
          
          showToast('تم حفظ التسوية الشهرية');
          
        } catch (error) {
          console.error('Error in monthly reconciliation for debit:', error);
          showToast('خطأ في التسوية الشهرية: ' + error.message);
        }
      });

      $('#creditMonthMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('من فضلك اختر بنك أولاً');
            return;
          }
          
          const month = Number($('#creditMonthSelect').value);
          const year = Number($('#creditYearInput').value);
          const bal = Number($('#creditMonthBankBalance').value);
          
          if (!month || !year) {
            showToast('من فضلك اختر الشهر والسنة');
            return;
          }
          
          if (!bal || bal <= 0) {
            showToast('من فضلك أدخل رصيد كشف البنك');
            return;
          }
          
          console.log('Monthly reconciliation for credit:', { month, year, balance: bal, currentBankId });
          
          // Calculate monthly total
          const total = await sumEntries(currentBankId, 'credit', monthStartISO(year, month), monthEndISO(year, month));
          $('#creditMonthTotal').value = formatAmount(total);
          
          // Calculate difference
          const diff = bal - total;
          $('#creditMonthMatchResult').textContent = diff === 0 ? '✅ متطابق' : `❌ الفرق: ${formatAmount(diff)}`;
          
          // Save monthly reconciliation
          const monthEnd = monthEndISO(year, month);
          await upsertReconciliation(currentBankId, monthEnd, bal);
          console.log('Monthly reconciliation saved for credit');
          
          showToast('تم حفظ التسوية الشهرية');
          
        } catch (error) {
          console.error('Error in monthly reconciliation for credit:', error);
          showToast('خطأ في التسوية الشهرية: ' + error.message);
        }
      });

      // Monthly
      const now2 = dayjs();
      $('#monthSelect').value = String(now2.month()+1);
      $('#yearInput').value = String(now2.year());
      $('#monthlyRunBtn').addEventListener('click', async (e)=>{
        e.preventDefault();
        await runMonthly();
      });
      $('#monthlyExportBtn').addEventListener('click', async ()=>{
        const m = Number($('#monthSelect').value); const y = Number($('#yearInput').value);
        const agg = await computeMonthlyAggregates(currentBankId, m, y);
        await exportMonthlyExcel(currentBankName, m, y, agg);
      });

      // Annual
      $('#fiscalStartYear').value = String(now2.month()+1 >= 7 ? now2.year() : now2.year()-1);
      $('#annualRunBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await runAnnual(); });
      $('#annualExportBtn').addEventListener('click', async ()=>{
        const fy = Number($('#fiscalStartYear').value);
        const rows = await computeFiscalYearAggregates(currentBankId, fy);
        await exportAnnualExcel(currentBankName, fy, rows);
      });

      // Initial load - Wait a bit for everything to be ready
      setTimeout(async () => {
        try {
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');
          console.log('Initial load completed successfully');
        } catch (error) {
          console.error('Error during initial load:', error);
        }
      }, 500);
    });

    async function runMonthly(){
      const m = Number($('#monthSelect').value); const y = Number($('#yearInput').value);
      const agg = await computeMonthlyAggregates(currentBankId, m, y);
      const tb = $('#monthlyTbody'); tb.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2 border border-border">${getMonthNameEn(m)} ${y}</td>
        <td class="px-3 py-2 border border-border text-right">${formatAmount(agg.opening)}</td>
        <td class="px-3 py-2 border border-border text-right">${formatAmount(agg.totalDebit)}</td>
        <td class="px-3 py-2 border border-border text-right">${formatAmount(agg.totalCredit)}</td>
        <td class="px-3 py-2 border border-border text-right">${formatAmount(agg.net)}</td>
        <td class="px-3 py-2 border border-border text-right">${formatAmount(agg.closing)}</td>
        <td class="px-3 py-2 border border-border text-right">${agg.count}</td>
      `;
      tb.appendChild(tr);
      $('#monthlyOpenTotal').textContent = formatAmount(agg.opening);
      $('#monthlyDebitTotal').textContent = formatAmount(agg.totalDebit);
      $('#monthlyCreditTotal').textContent = formatAmount(agg.totalCredit);
      $('#monthlyNetTotal').textContent = formatAmount(agg.net);
      $('#monthlyCloseTotal').textContent = formatAmount(agg.closing);
      $('#monthlyCountTotal').textContent = String(agg.count);
    }

    async function runAnnual(){
      const fy = Number($('#fiscalStartYear').value);
      const rows = await computeFiscalYearAggregates(currentBankId, fy);
      const tb = $('#annualTbody'); tb.innerHTML = '';
      let openTotal=0, debitTotal=0, creditTotal=0, netTotal=0, closeTotal=0;
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 border border-border">${getMonthNameEn(r.month)} ${r.year}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.opening)}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.totalDebit)}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.totalCredit)}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.net)}</td>
          <td class="px-3 py-2 border border-border text-right">${formatAmount(r.closing)}</td>
        `;
        tb.appendChild(tr);
        openTotal += r.opening; debitTotal += r.totalDebit; creditTotal += r.totalCredit; netTotal += r.net; closeTotal = r.closing; // closing of last month
      }
      $('#annualOpenTotal').textContent = formatAmount(openTotal);
      $('#annualDebitTotal').textContent = formatAmount(debitTotal);
      $('#annualCreditTotal').textContent = formatAmount(creditTotal);
      $('#annualNetTotal').textContent = formatAmount(netTotal);
      $('#annualCloseTotal').textContent = formatAmount(closeTotal);
    }
    </script>
</body>
</html>