<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
    <script>
      // Check if fonts are loaded
      document.fonts.ready.then(() => {
        console.log('Fonts loaded successfully');
      }).catch(() => {
        console.warn('Fonts failed to load, using system fonts');
        // Fallback to system fonts
        document.body.style.fontFamily = 'Arial, sans-serif';
      });
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Check if Tailwind is loaded
      if (typeof tailwind === 'undefined') {
        console.error('Tailwind CSS failed to load!');
        // Add basic CSS fallback
        const style = document.createElement('style');
        style.textContent = `
          .bg-primary { background-color: #2563eb !important; }
          .bg-primary-hover { background-color: #1e4fd6 !important; }
          .text-white { color: white !important; }
          .border-border { border-color: #e5e7eb !important; }
          .bg-white { background-color: white !important; }
          .hidden { display: none !important; }
          .flex { display: flex !important; }
          .grid { display: grid !important; }
          .rounded-md { border-radius: 0.375rem !important; }
          .px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
          .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
        `;
        document.head.appendChild(style);
      }

      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#2563eb', hover: '#1e4fd6' },
              bg: '#f7f9fc',
              border: '#e5e7eb',
              text: '#0f172a'
            },
            fontFamily: {
              sans: ['Cairo','Tajawal','ui-sans-serif','system-ui']
            }
          }
        }
      }
    </script>

    <!-- Day.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script>
      // Check if dayjs is loaded
      if (typeof dayjs === 'undefined') {
        console.error('Day.js failed to load!');
        // Fallback to basic date functions
        window.dayjs = {
          format: () => new Date().toISOString().split('T')[0],
          month: () => new Date().getMonth(),
          year: () => new Date().getFullYear(),
          extend: () => {},
          subtract: () => ({ format: () => new Date().toISOString().split('T')[0] }),
          endOf: () => ({ format: () => new Date().toISOString().split('T')[0] })
        };
      }
    </script>

    <!-- ExcelJS + FileSaver for styled Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
      // Check if ExcelJS is loaded
      if (typeof ExcelJS === 'undefined') {
        console.error('ExcelJS failed to load!');
        window.ExcelJS = { Workbook: class {} };
      }

      // Check if FileSaver is loaded
      if (typeof saveAs === 'undefined') {
        console.error('FileSaver failed to load!');
        window.saveAs = (blob, filename) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        };
      }
    </script>

    <style>
      html, body { height: 100%; }
      body { background: #f7f9fc; color: #0f172a; font-family: Cairo, Tajawal, ui-sans-serif, system-ui; }
      @media print {
        @page { size: A4 landscape; margin: 12mm; }
        .no-print { display: none !important; }
        thead { display: table-header-group; }
      }
      ::-webkit-scrollbar { width: 10px; height: 10px; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header / Navbar -->
    <header class="no-print bg-white shadow-sm border-b border-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-lg">â‚ª</div>
                <h1 class="text-xl font-semibold">Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ</h1>
            </div>
            <div class="flex-1"></div>
            <div class="flex items-center gap-2">
                <label for="bankSelect" class="text-sm text-slate-600">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ</label>
                <select id="bankSelect" class="px-3 py-2 border border-border rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                </select>
                <button id="addBankBtn" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-primary-hover text-sm">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ</button>
                <div class="flex items-center gap-2">

                </div>
            </div>
        </div>
        <nav class="bg-white border-t border-border">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex flex-wrap gap-2">
                <button data-nav="home" class="nav-btn px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button data-nav="debit" class="nav-btn px-4 py-2 rounded-md bg-primary text-white hover:bg-primary-hover">â• Ø¥Ø¶Ø§ÙØ© ØªØ³ÙˆÙŠØ© (Ù…Ø¯ÙŠÙ†)</button>
                <button data-nav="credit" class="nav-btn px-4 py-2 rounded-md bg-primary text-white hover:bg-primary-hover">ğŸ“„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ (Ø¯Ø§Ø¦Ù†)</button>
                <button data-nav="reports" class="nav-btn px-4 py-2 rounded-md border border-border bg-white hover:bg-slate-50">ğŸ“‘ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

                <div class="flex-1"></div>

            </div>
        </nav>
    </header>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

        <!-- Home Section -->
        <section data-section="home" class="section">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <h2 class="text-lg font-semibold mb-2">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ</h2>
                <p class="text-slate-600 mb-4">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙˆØ¯ ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</p>

                <!-- Banks Section -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3 text-center">ğŸ¦ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                    <div id="banksGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Banks will be populated here -->
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button data-nav="debit" class="px-4 py-6 rounded-xl bg-primary text-white hover:bg-primary-hover text-center">â• ØªØ³ÙˆÙŠØ© (Ù…Ø¯ÙŠÙ†)</button>
                    <button data-nav="credit" class="px-4 py-6 rounded-xl bg-primary text-white hover:bg-primary-hover text-center">ğŸ“„ Ù…Ø³ØªÙ†Ø¯ (Ø¯Ø§Ø¦Ù†)</button>
                </div>
            </div>
        </section>

        <!-- Debit Section -->
        <section data-section="debit" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-center border-b-4 border-primary pb-2">Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠÙ† (ØªØ³ÙˆÙŠØ§Øª)</h2>
                    <button data-nav="home" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                        ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>
                
                <!-- Form -->
                <form id="debitForm" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="debitDate" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                        <input type="text" id="debitDesc" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="text" id="debitAmount" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 100+50+300" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <input type="text" id="debitNotes" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-5">
                        <button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯</button>
                    </div>
                </form>

                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                        <input type="text" id="debitSearch" class="w-full px-3 py-2 border border-border rounded-md" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="debitFrom" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1"></label>
                        <input type="date" id="debitTo" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="flex gap-2">
                        <button id="debitFilterBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">ØªØµÙÙŠØ©</button>
                        <button id="debitClearBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">Ù…Ø³Ø­</button>
                    </div>
                </div>


                <!-- Table -->
                <div id="debitTableWrap" class="overflow-auto max-h-96">
                    <table class="min-w-full border border-border rounded-md">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 border-2 border-border text-right">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                <th class="px-3 py-2 border-2 border-border text-center">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="px-3 py-2 border-2 border-border text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th class="px-3 py-2 border-2 border-border text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="debitTableBody"></tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td class="px-3 py-2 border border-border" colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                <td class="px-3 py-2 border border-border text-right" id="debitTotal">0.00</td>
                                <td class="px-3 py-2 border border-border"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Daily Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
                            <input type="date" id="debitRecDate" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ</label>
                            <input type="number" id="debitBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ… (Ù…Ø¯ÙŠÙ†)</label>
                            <input type="text" id="debitDayTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="debitMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ù…Ø·Ø§Ø¨Ù‚Ø© ÙŠÙˆÙ…ÙŠØ©</button>
                            <span id="debitMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="debitMonthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                                <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                                <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                <option value="3">Ù…Ø§Ø±Ø³</option>
                                <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                                <option value="5">Ù…Ø§ÙŠÙˆ</option>
                                <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                                <option value="8">Ø£ØºØ³Ø·Ø³</option>
                                <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø§Ù„Ø³Ù†Ø©</label>
                            <input type="number" id="debitYearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ</label>
                            <input type="number" id="debitMonthBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø± (Ù…Ø¯ÙŠÙ†)</label>
                            <input type="text" id="debitMonthTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="debitMonthMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ù…Ø·Ø§Ø¨Ù‚Ø© Ø´Ù‡Ø±ÙŠØ©</button>
                            <span id="debitMonthMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Credit Section -->
        <section data-section="credit" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-center border-b-4 border-primary pb-2">Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø§Ø¦Ù† (Ù…Ø³ØªÙ†Ø¯Ø§Øª)</h2>
                    <button data-nav="home" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                        ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>
                
                <!-- Form -->
                <form id="creditForm" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="creditDate" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                        <input type="text" id="creditDesc" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="text" id="creditAmount" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 100+50+300" required class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <input type="text" id="creditNotes" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="md:col-span-5">
                        <button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯</button>
                    </div>
                </form>

                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                        <input type="text" id="creditSearch" class="w-full px-3 py-2 border border-border rounded-md" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="creditFrom" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1"></label>
                        <input type="date" id="creditTo" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div class="flex gap-2">
                        <button id="creditFilterBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">ØªØµÙÙŠØ©</button>
                        <button id="creditClearBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">Ù…Ø³Ø­</button>
                    </div>
                </div>


                <!-- Table -->
                <div id="creditTableWrap" class="overflow-auto max-h-96">
                    <table class="min-w-full border border-border rounded-md">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 border-2 border-border text-right">Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„</th>
                                <th class="px-3 py-2 border-2 border-border text-center">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="px-3 py-2 border-2 border-border text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th class="px-3 py-2 border-2 border-border text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="creditTableBody"></tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td class="px-3 py-2 border border-border" colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                <td class="px-3 py-2 border border-border text-right" id="creditTotal">0.00</td>
                                <td class="px-3 py-2 border border-border"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Daily Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
                            <input type="date" id="creditRecDate" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ</label>
                            <input type="number" id="creditBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ… (Ø¯Ø§Ø¦Ù†)</label>
                            <input type="text" id="creditDayTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="creditMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ù…Ø·Ø§Ø¨Ù‚Ø© ÙŠÙˆÙ…ÙŠØ©</button>
                            <span id="creditMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Reconciliation -->
                <div class="bg-slate-50 p-4 rounded-xl border border-border">
                    <h3 class="font-semibold mb-3">Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                        <div>
                            <label class="block text-sm mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="creditMonthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                                <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                                <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                                <option value="3">Ù…Ø§Ø±Ø³</option>
                                <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                                <option value="5">Ù…Ø§ÙŠÙˆ</option>
                                <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                                <option value="8">Ø£ØºØ³Ø·Ø³</option>
                                <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                                <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                                <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø§Ù„Ø³Ù†Ø©</label>
                            <input type="number" id="creditYearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ</label>
                            <input type="number" id="creditMonthBankBalance" step="0.01" class="w-full px-3 py-2 border border-border rounded-md" />
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø± (Ø¯Ø§Ø¦Ù†)</label>
                            <input type="text" id="creditMonthTotal" class="w-full px-3 py-2 border border-border rounded-md bg-slate-100" readonly />
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="creditMonthMatchBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ù…Ø·Ø§Ø¨Ù‚Ø© Ø´Ù‡Ø±ÙŠØ©</button>
                            <span id="creditMonthMatchResult" class="px-3 py-2"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Monthly Report Section -->
        <section data-section="monthly" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-center">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
                    <button data-nav="home" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                        ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="monthSelect" class="w-full px-3 py-2 border border-border rounded-md">
                            <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                            <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                            <option value="3">Ù…Ø§Ø±Ø³</option>
                            <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                            <option value="5">Ù…Ø§ÙŠÙˆ</option>
                            <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                            <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                            <option value="8">Ø£ØºØ³Ø·Ø³</option>
                            <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                            <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                            <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                            <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ø³Ù†Ø©</label>
                        <input type="number" id="yearInput" class="w-full px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                    </div>
                    <div class="flex gap-2 md:col-span-2">
                        <button id="monthlyRunBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        <button id="monthlyExportBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                </div>

                <div class="overflow-auto">
                    <table class="min-w-full border border-border rounded-md">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-3 py-2 border border-border text-center">Ø§Ù„Ø¨Ù†Ùƒ</th>
                                <th class="px-3 py-2 border border-border text-center">Ø§Ù„Ù…Ø¯ÙŠÙ†</th>
                                <th class="px-3 py-2 border border-border text-center">Ø§Ù„Ø¯Ø§Ø¦Ù†</th>
                                <th class="px-3 py-2 border border-border text-center">Ø§Ù„ØµØ§ÙÙŠ</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTbody"></tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td class="px-3 py-2 border border-border text-center">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                <td class="px-3 py-2 border border-border text-center" id="monthlyDebitTotal">0.00</td>
                                <td class="px-3 py-2 border border-border text-center" id="monthlyCreditTotal">0.00</td>
                                <td class="px-3 py-2 border border-border text-center" id="monthlyNetTotal">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section data-section="reports" class="section hidden">
            <div class="bg-white rounded-xl shadow-sm border border-border p-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-center border-b-4 border-primary pb-2">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
                    <button data-nav="home" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                        ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                    <div>
                        <label class="block text-sm mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="reportFrom" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="reportTo" class="w-full px-3 py-2 border border-border rounded-md" />
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm mb-1">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <input type="text" id="reportSearch" class="w-full px-3 py-2 border border-border rounded-md" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«" />
                    </div>
                    <div class="flex gap-2">
                        <button id="reportFilterBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">ØªØµÙÙŠØ©</button>
                        <button id="reportClearBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="bg-slate-50 p-3 rounded-lg flex flex-wrap items-end gap-2">
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="reportMonthSelect" class="px-3 py-2 border border-border rounded-md"></select>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Ø§Ù„Ø³Ù†Ø©</label>
                        <input type="number" id="reportYearInput" class="px-3 py-2 border border-border rounded-md" min="2000" max="2100" />
                    </div>
                    <button id="reportExportDailyBtn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§ÙƒØ³Ù„ ÙÙ„ØªØ±Ø©</button>
                    <button id="reportExportMonthlyBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§ÙƒØ³Ù„ Ø´Ù‡Ø±ÙŠ</button>
                    <button id="reportExportAnnualBtn" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§ÙƒØ³Ù„ Ø³Ù†ÙˆÙŠ</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Add Bank Modal -->
    <div id="bankModal" class="no-print hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg border border-border w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
                    <input type="text" id="newBankName" class="w-full px-3 py-2 border border-border rounded-md" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ" />
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button id="bankCancelBtn" class="px-4 py-2 border border-border rounded-md bg-white hover:bg-slate-50">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="bankSaveBtn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="no-print fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-md shadow-lg hidden"></div>

    <script>
    // ===============================
    // Utilities
    // ===============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const on = (sel, evt, handler) => { const el = $(sel); if(el) el.addEventListener(evt, handler); };
    const debounce = (fn, delay = 300) => { let timeoutId; return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => fn(...args), delay); }; };
    const normalize = (s) => String(s || '').toLowerCase();
function parseAmountExpression(input){
  const cleaned = String(input||'').replace(/\s+/g,'');
  if(!cleaned){ return NaN; }
  const parts = cleaned.split('+');
  let sum = 0;
  for(const p of parts){
    const n = Number(String(p).replace(/,/g,''));
    if(!isFinite(n)){ return NaN; }
    sum += n;
  }
  return sum;
}
    const showToast = (msg) => {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 2000);
    }
    const formatAmount = (n) => (Number(n)||0).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    const todayISO = () => {
      console.log(`todayISO called, dayjs available:`, typeof dayjs !== 'undefined');
      if (typeof dayjs === 'undefined') {
        console.error('dayjs is not available!');
        return '2000-01-01';
      }
      const result = dayjs().format('YYYY-MM-DD');
      console.log(`todayISO() = ${result}`);
      return result;
    };

    function getMonthNameEn(m){
      return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1];
    }

    function monthStartISO(year, month){
      console.log(`monthStartISO called with:`, { year, month, dayjsAvailable: typeof dayjs !== 'undefined' });
      if (typeof dayjs === 'undefined') {
        console.error('dayjs is not available!');
        return '2000-01-01';
      }
      const result = dayjs(`${year}-${String(month).padStart(2,'0')}-01`).format('YYYY-MM-DD');
      console.log(`monthStartISO(${year}, ${month}) = ${result}`);
      return result;
    }
    function monthEndISO(year, month){
      console.log(`monthEndISO called with:`, { year, month, dayjsAvailable: typeof dayjs !== 'undefined' });
      if (typeof dayjs === 'undefined') {
        console.error('dayjs is not available!');
        return '2000-01-31';
      }
      const result = dayjs(monthStartISO(year,month)).endOf('month').format('YYYY-MM-DD');
      console.log(`monthEndISO(${year}, ${month}) = ${result}`);
      return result;
    }
    function dayBeforeISO(dateISO){ return dayjs(dateISO).subtract(1,'day').format('YYYY-MM-DD'); }

    // ===============================
    // Storage Setup (IndexedDB + localStorage fallback)
    // ===============================
    const DB_NAME = 'bankLedgerDB';
    const DB_VERSION = 2;
    let dbInstance = null;
    let useLocalStorage = false;

    function openDB(){
      return new Promise((resolve, reject)=>{
        if(dbInstance){ resolve(dbInstance); return; }
        
        // Check if IndexedDB is available
        if (!window.indexedDB) {
          console.log('IndexedDB not available, using localStorage');
          useLocalStorage = true;
          resolve('localStorage');
          return;
        }

        console.log('Opening IndexedDB...');
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => {
          console.error('IndexedDB error:', req.error);
          console.log('Falling back to localStorage');
          useLocalStorage = true;
          resolve('localStorage');
        };
        req.onupgradeneeded = (ev) => {
          console.log('Upgrading database...');
          const db = ev.target.result;
          // banks
          if(!db.objectStoreNames.contains('banks')){
            const s = db.createObjectStore('banks', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_name', 'name', { unique: true });
            console.log('Created banks store');
          }
          // entries
          if(!db.objectStoreNames.contains('entries')){
            const s = db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_bankId', 'bankId');
            s.createIndex('by_bankId_type_date', ['bankId','type','dateISO']);
            s.createIndex('by_bankId_date', ['bankId','dateISO']);
            console.log('Created entries store');
          }
          // reconciliations
          if(!db.objectStoreNames.contains('reconciliations')){
            const s = db.createObjectStore('reconciliations', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_bankId_date', ['bankId','dateISO'], { unique: true });
            console.log('Created reconciliations store');
          }
          // archives for rolled years
          if(!db.objectStoreNames.contains('archives')){
            const s = db.createObjectStore('archives', { keyPath: 'id', autoIncrement: true });
            s.createIndex('by_bankId_fy', ['bankId','fiscalStartYear']);
            console.log('Created archives store');
          }
          // metadata
          if(!db.objectStoreNames.contains('meta')){
            const s = db.createObjectStore('meta', { keyPath: 'key' });
            console.log('Created meta store');
          }
        };
        req.onsuccess = async () => {
          console.log('IndexedDB opened successfully');
          dbInstance = req.result;
          dbInstance.onversionchange = () => dbInstance.close();
          resolve(dbInstance);
        }
      });
    }

    function tx(storeNames, mode='readonly'){
      if (useLocalStorage) return Promise.resolve('localStorage');
      return openDB().then(db => db.transaction(storeNames, mode));
    }

    // Banks
    async function addBank(name){
      if (useLocalStorage) {
        const banks = JSON.parse(localStorage.getItem('banks') || '[]');
        const newBank = { id: Date.now(), name, createdAt: new Date().toISOString() };
        banks.push(newBank);
        localStorage.setItem('banks', JSON.stringify(banks));
        return newBank.id;
      }
      
      const t = await tx(['banks'], 'readwrite');
      const s = t.objectStore('banks');
      return new Promise((resolve, reject)=>{
        const req = s.add({ name, createdAt: new Date().toISOString() });
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function listBanks(){
      if (useLocalStorage) {
        const banks = JSON.parse(localStorage.getItem('banks') || '[]');
        return banks;
      }
      
      const t = await tx(['banks']);
      const s = t.objectStore('banks');
      return new Promise((resolve, reject)=>{
        const req = s.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    // Entries
    async function addEntry(entry){
      let result;
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        const newEntry = { id: Date.now(), ...entry, createdAt: new Date().toISOString() };
        entries.push(newEntry);
        localStorage.setItem('entries', JSON.stringify(entries));
        result = newEntry.id;
      } else {
        const t = await tx(['entries'], 'readwrite');
        const s = t.objectStore('entries');
        result = await new Promise((resolve, reject)=>{
          const req = s.add({ ...entry, createdAt: new Date().toISOString() });
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      
      // Update banks grid after adding entry
      try {
        await updateBanksGrid();
      } catch (error) {
        console.error('Error updating banks grid after adding entry:', error);
      }

      return result;
    }

    async function listEntriesByBankAndFilters(bankId, type, {searchText='', fromDateISO='', toDateISO=''}={}){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        let results = entries.filter(e => e.bankId === bankId && e.type === type);
        
        // Filter by date range
        if (fromDateISO) {
          results = results.filter(e => e.dateISO >= fromDateISO);
        }
        if (toDateISO) {
          results = results.filter(e => e.dateISO <= toDateISO);
        }
        
        // Filter by search text
        const st = (searchText || '').trim().toLowerCase();
        if (st) {
          results = results.filter(e => {
            const desc = String(e.description || '').toLowerCase();
            const notes = String(e.notes || '').toLowerCase();
            const date = String(e.dateISO || '').toLowerCase();
            const amountStr = String(e.amount != null ? e.amount : '').toLowerCase();
            return desc.includes(st) || notes.includes(st) || date.includes(st) || amountStr.includes(st);
          });
        }
        // Sort ascending by date (top to bottom)
        results.sort((a,b)=> String(a.dateISO).localeCompare(String(b.dateISO)));
        
        return results;
      }
      
      const t = await tx(['entries']);
      const s = t.objectStore('entries');
      const idx = s.index('by_bankId_type_date');
      const lower = [bankId, type, fromDateISO || '0000-01-01'];
      const upper = [bankId, type, toDateISO || '9999-12-31'];
      const range = IDBKeyRange.bound(lower, upper);
      return new Promise((resolve, reject)=>{
        const results = [];
        const req = idx.openCursor(range);
        req.onsuccess = (ev) => {
          const cursor = ev.target.result;
          if(cursor){
            const v = cursor.value;
            const st = (searchText || '').trim().toLowerCase();
            if(!st || String(v.description || '').toLowerCase().includes(st) || String(v.notes || '').toLowerCase().includes(st) || String(v.dateISO || '').toLowerCase().includes(st) || String(v.amount != null ? v.amount : '').toLowerCase().includes(st)){
              results.push(v);
            }
            cursor.continue();
          } else {
            resolve(results);
          }
        }
        req.onerror = () => reject(req.error);
      });
    }

    async function sumEntries(bankId, type, fromISO, toISO){
      console.log(`sumEntries called with:`, { bankId, type, fromISO, toISO, useLocalStorage });

      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        console.log(`Total entries in localStorage:`, entries.length);

        let results = entries.filter(e => e.bankId === bankId && e.type === type);
        console.log(`Entries after bank and type filter:`, results.length);
        
        // Filter by date range
        if (fromISO) {
          results = results.filter(e => e.dateISO >= fromISO);
          console.log(`Entries after fromISO filter (${fromISO}):`, results.length);
        }
        if (toISO) {
          results = results.filter(e => e.dateISO <= toISO);
          console.log(`Entries after toISO filter (${toISO}):`, results.length);
        }
        
        const total = results.reduce((acc, r)=> acc + Number(r.amount||0), 0);
        console.log(`Final sum result:`, total);
        return total;
      }
      
      const rows = await listEntriesByBankAndFilters(bankId, type, { fromDateISO: fromISO, toDateISO: toISO });
      const total = rows.reduce((acc, r)=> acc + Number(r.amount||0), 0);
      console.log(`IndexedDB sum result:`, total);
      return total;
    }

    // Reconciliations
    async function upsertReconciliation(bankId, dateISO, bankStatementBalance){
      if (useLocalStorage) {
        const reconciliations = JSON.parse(localStorage.getItem('reconciliations') || '[]');
        const existingIndex = reconciliations.findIndex(r => r.bankId === bankId && r.dateISO === dateISO);
        
        if (existingIndex >= 0) {
          reconciliations[existingIndex].bankStatementBalance = bankStatementBalance;
        } else {
          reconciliations.push({ id: Date.now(), bankId, dateISO, bankStatementBalance });
        }
        
        localStorage.setItem('reconciliations', JSON.stringify(reconciliations));
        return true;
      }
      
      const t = await tx(['reconciliations'], 'readwrite');
      const s = t.objectStore('reconciliations');
      const idx = s.index('by_bankId_date');
      return new Promise((resolve, reject)=>{
        const getReq = idx.get([bankId, dateISO]);
        getReq.onsuccess = () => {
          const existing = getReq.result;
          if(existing){
            const putReq = s.put({ ...existing, bankStatementBalance });
            putReq.onsuccess = () => resolve(putReq.result);
            putReq.onerror = () => reject(putReq.error);
          } else {
            const addReq = s.add({ bankId, dateISO, bankStatementBalance });
            addReq.onsuccess = () => resolve(addReq.result);
            addReq.onerror = () => reject(addReq.error);
          }
        }
        getReq.onerror = () => reject(getReq.error);
      });
    }

    async function getReconciliation(bankId, dateISO){
      if (useLocalStorage) {
        const reconciliations = JSON.parse(localStorage.getItem('reconciliations') || '[]');
        return reconciliations.find(r => r.bankId === bankId && r.dateISO === dateISO) || null;
      }
      
      const t = await tx(['reconciliations']);
      const s = t.objectStore('reconciliations');
      const idx = s.index('by_bankId_date');
      return new Promise((resolve, reject)=>{
        const req = idx.get([bankId, dateISO]);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    // Balances and aggregates
    async function computeOpeningBalance(bankId, startDateExclusiveISO){
      if (useLocalStorage) {
        const entries = JSON.parse(localStorage.getItem('entries') || '[]');
        const dayBefore = dayBeforeISO(startDateExclusiveISO);
        
        const debit = entries
          .filter(e => e.bankId === bankId && e.type === 'debit' && e.dateISO < startDateExclusiveISO)
          .reduce((sum, e) => sum + Number(e.amount || 0), 0);
          
        const credit = entries
          .filter(e => e.bankId === bankId && e.type === 'credit' && e.dateISO < startDateExclusiveISO)
          .reduce((sum, e) => sum + Number(e.amount || 0), 0);
          
        return debit - credit;
      }
      
      const beforeFrom = '0000-01-01';
      const dayBefore = dayBeforeISO(startDateExclusiveISO);
      const debit = await sumEntries(bankId, 'debit', beforeFrom, dayBefore);
      const credit = await sumEntries(bankId, 'credit', beforeFrom, dayBefore);
      return debit - credit;
    }

    async function computeMonthlyAggregates(bankId, month, year){
      if (useLocalStorage) {
        const start = monthStartISO(year, month);
        const end = monthEndISO(year, month);
        const opening = await computeOpeningBalance(bankId, start);
        const totalDebit = await sumEntries(bankId, 'debit', start, end);
        const totalCredit = await sumEntries(bankId, 'credit', start, end);
        const net = totalDebit - totalCredit;
        const closing = opening + net;
        const debitEntries = await listEntriesByBankAndFilters(bankId, 'debit', { fromDateISO: start, toDateISO: end });
        const creditEntries = await listEntriesByBankAndFilters(bankId, 'credit', { fromDateISO: start, toDateISO: end });
        return { start, end, opening, totalDebit, totalCredit, net, closing, count: debitEntries.length + creditEntries.length, debitEntries, creditEntries };
      }
      
      const start = monthStartISO(year, month);
      const end = monthEndISO(year, month);
      const opening = await computeOpeningBalance(bankId, start);
      const totalDebit = await sumEntries(bankId, 'debit', start, end);
      const totalCredit = await sumEntries(bankId, 'credit', start, end);
      const net = totalDebit - totalCredit;
      const closing = opening + net;
      const debitEntries = await listEntriesByBankAndFilters(bankId, 'debit', { fromDateISO: start, toDateISO: end });
      const creditEntries = await listEntriesByBankAndFilters(bankId, 'credit', { fromDateISO: start, toDateISO: end });
      return { start, end, opening, totalDebit, totalCredit, net, closing, count: debitEntries.length + creditEntries.length, debitEntries, creditEntries };
    }

    async function computeFiscalYearAggregates(bankId, fiscalStartYear){
      if (useLocalStorage) {
        // months Jul..Dec of start year, then Jan..Jun of next year
        const months = [7,8,9,10,11,12,1,2,3,4,5,6];
        const rows = [];
        let y = fiscalStartYear;
        for(const m of months){
          const year = (m >= 7 ? fiscalStartYear : fiscalStartYear + 1);
          const agg = await computeMonthlyAggregates(bankId, m, year);
          rows.push({ month: m, year, ...agg });
        }
        return rows;
      }
      
      // months Jul..Dec of start year, then Jan..Jun of next year
      const months = [7,8,9,10,11,12,1,2,3,4,5,6];
      const rows = [];
      let y = fiscalStartYear;
      for(const m of months){
        const year = (m >= 7 ? fiscalStartYear : fiscalStartYear + 1);
        const agg = await computeMonthlyAggregates(bankId, m, year);
        rows.push({ month: m, year, ...agg });
      }
      return rows;
    }

    // ===============================
    // State
    // ===============================
    let currentBankId = null;
    let currentBankName = '';

    async function refreshBankSelector(){
      try {
        const banks = await listBanks();
        console.log('Banks loaded:', banks);
        const sel = $('#bankSelect');
        sel.innerHTML = '';
        
        // If no banks exist, create default bank only once
        if(banks.length === 0){
          console.log('No banks found, creating default bank...');
          await addBank('Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
          // Get the updated list
          const updatedBanks = await listBanks();
          banks.length = 0;
          banks.push(...updatedBanks);
        }
        
        for(const b of banks){
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.name;
          sel.appendChild(opt);
        }
        
        // Set current bank from localStorage if available
        const savedBankId = localStorage.getItem('currentBankId');
        const savedBankName = localStorage.getItem('currentBankName');
        console.log('Saved bank from localStorage:', { id: savedBankId, name: savedBankName });
        
        if(savedBankId && banks.find(b => b.id == savedBankId)){
          currentBankId = Number(savedBankId);
          currentBankName = savedBankName || banks.find(b => b.id == currentBankId)?.name;
          console.log('Restored bank from localStorage:', currentBankId, currentBankName);
        } else if(banks[0]){
          currentBankId = banks[0].id;
          currentBankName = banks[0].name;
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);
          console.log('Set default bank and saved to localStorage:', currentBankId, currentBankName);
        }
        
        if(currentBankId){
          sel.value = String(currentBankId);
          console.log('Bank selector set to:', currentBankId);
        }
        console.log('Bank selector refreshed, currentBankId:', currentBankId, 'currentBankName:', currentBankName);

        // Update banks grid in home section
        await updateBanksGrid();
      } catch (error) {
        console.error('Error refreshing bank selector:', error);
      }
    }

    async function openBank(bankId, section){
      try {
        console.log('Opening bank:', bankId, 'section:', section);

        // Set the bank as current
        const banks = await listBanks();
        const bank = banks.find(b => b.id == bankId);
        if (!bank) {
          showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ùƒ');
          return;
        }

        // Update current bank
        currentBankId = Number(bankId);
        currentBankName = bank.name;
        localStorage.setItem('currentBankId', String(currentBankId));
        localStorage.setItem('currentBankName', currentBankName);

        // Update bank selector
        $('#bankSelect').value = String(currentBankId);

        // Navigate to the specified section
        setSection(section);

        // Load data for the bank
        await reloadEntries(section);
        await updateDailyTotals(section);
        await updateMonthlyTotals(section);

        showToast(`ØªÙ… ÙØªØ­ ${bank.name} - ${section === 'debit' ? 'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª' : 'Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª'}`);

        console.log('Bank opened successfully:', { bankId, bankName: bank.name, section });
      } catch (error) {
        console.error('Error opening bank:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„Ø¨Ù†Ùƒ: ' + error.message);
      }
    }

    async function showDailyReport(type){
      try {
        if (!currentBankId) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        const fromDate = type === 'debit' ? $('#debitFrom').value : $('#creditFrom').value;
        const toDate = type === 'debit' ? $('#debitTo').value : $('#creditTo').value;

        if (!fromDate || !toDate) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®');
          return;
        }

        const entries = await listEntriesByBankAndFilters(currentBankId, type, {
          fromDateISO: fromDate,
          toDateISO: toDate
        });

        if (entries.length === 0) {
          showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯');
          return;
        }

        // Show report in new window
        const reportWindow = window.open('', '_blank', 'width=800,height=600');
        const reportContent = generateDailyReportHTML(type, entries, fromDate, toDate);
        reportWindow.document.write(reportContent);
        reportWindow.document.close();

      } catch (error) {
        console.error('Error showing daily report:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
      }
    }

    function generateDailyReportHTML(type, entries, fromDate, toDate){
      const total = entries.reduce((sum, e) => sum + Number(e.amount || 0), 0);
      const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const typeText = type === 'debit' ? 'Ù…Ø¯ÙŠÙ†' : 'Ø¯Ø§Ø¦Ù†';

      return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>ØªÙ‚Ø±ÙŠØ± ${typeText} - ${bankName}</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            .info { display: flex; justify-content: space-between; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }
            th { background-color: #f8f9fa; font-weight: bold; }
            .total { font-weight: bold; background-color: #e9ecef; }
            @media print { body { margin: 0; } .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>ØªÙ‚Ø±ÙŠØ± ${typeText}</h1>
            <h2>${bankName}</h2>
            <p>Ù…Ù† ${fromDate} Ø¥Ù„Ù‰ ${toDate}</p>
          </div>

          <div class="info">
            <div>
              <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯:</strong> ${entries.length}
            </div>
            <div>
              <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatAmount(total)}
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${entries.map(entry => `
                <tr>
                  <td>${entry.description || ''}</td>
                  <td>${entry.dateISO}</td>
                  <td>${formatAmount(entry.amount)}</td>
                  <td>${entry.notes || ''}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr class="total">
                <td colspan="2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                <td>${formatAmount(total)}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>


        </body>
        </html>
      `;
    }

    function printDailyReport(type){
      const fromDate = type === 'debit' ? $('#debitFrom').value : $('#creditFrom').value;
      const toDate = type === 'debit' ? $('#debitTo').value : $('#creditTo').value;

      if (!fromDate || !toDate) {
        showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®');
        return;
      }

      // Create print-friendly content
      const printContent = generateDailyReportHTML(type, [], fromDate, toDate);
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();

      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    async function exportDailyExcel(type){
      // Deprecated single-sheet export kept for compatibility; replaced by exportDailyExcelDualSheets
    
      try {
        if (!currentBankId) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        const fromDate = type === 'debit' ? $('#debitFrom').value : $('#creditFrom').value;
        const toDate = type === 'debit' ? $('#debitTo').value : $('#creditTo').value;

        if (!fromDate || !toDate) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®');
          return;
        }

        const entries = await listEntriesByBankAndFilters(currentBankId, type, {
          fromDateISO: fromDate,
          toDateISO: toDate
        });

        if (entries.length === 0) {
          showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯');
          return;
        }

        await exportDailyExcelFile(type, entries, fromDate, toDate);

      } catch (error) {
        console.error('Error exporting daily Excel:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
      }
    }

    async function exportDailyExcelFile(type, entries, fromDate, toDate){
      try {
        const wb = new ExcelJS.Workbook();
        const typeText = type === 'debit' ? 'Ù…Ø¯ÙŠÙ†' : 'Ø¯Ø§Ø¦Ù†';
        const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const sheetName = `${typeText} - ${bankName}`;
        const ws = wb.addWorksheet(sheetName);

        // Add header info
        ws.getRow(1).values = ['ØªÙ‚Ø±ÙŠØ± ' + typeText];
        ws.getRow(2).values = ['Ø§Ù„Ø¨Ù†Ùƒ:', bankName];
        ws.getRow(3).values = ['Ù…Ù† ØªØ§Ø±ÙŠØ®:', fromDate];
        ws.getRow(4).values = ['Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:', toDate];
        ws.getRow(5).values = ['Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯:', entries.length];
        ws.getRow(6).values = ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:', entries.reduce((sum, e) => sum + Number(e.amount || 0), 0)];

        // Add table headers
        ws.getRow(8).values = ['Ø§Ù„Ø¨ÙŠØ§Ù†', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'];

        // Style header row
              const headerRow = ws.getRow(8);
      headerRow.eachCell(cell => {
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
        cell.font = { bold: true };
        cell.border = { top: { style: 'medium' }, left: { style: 'medium' }, bottom: { style: 'medium' }, right: { style: 'medium' } };
      });

        // Add data rows
        let rowIndex = 9;
        for (const entry of entries) {
          ws.getRow(rowIndex).values = [
            entry.description || '',
            entry.dateISO,
            Number(entry.amount),
            entry.notes || ''
          ];

          // Style data row
          const dataRow = ws.getRow(rowIndex);
          dataRow.eachCell(cell => {
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            if (typeof cell.value === 'number') {
              cell.numFmt = '#,##0.00';
            }
          });

          rowIndex++;
        }

        // Add totals row
        const totalRow = ws.getRow(rowIndex);
        totalRow.values = ['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', '', entries.reduce((sum, e) => sum + Number(e.amount || 0), 0), ''];
        ws.autoFilter = { from: { row: 8, column: 1 }, to: { row: rowIndex, column: 4 } };
        totalRow.eachCell(cell => {
          cell.font = { bold: true };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
          cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
          if (typeof cell.value === 'number') {
            cell.numFmt = '#,##0.00';
          }
        });

        // Set column widths
        ws.getColumn(1).width = 35; // Ø§Ù„Ø¨ÙŠØ§Ù† ÙƒØ¨ÙŠØ±
        ws.getColumn(2).width = 12; // Ø§Ù„ØªØ§Ø±ÙŠØ®
        ws.getColumn(3).width = 14; // Ø§Ù„Ù…Ø¨Ù„Øº
        ws.getColumn(4).width = 18; // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØµØºÙŠØ±Ø©

        // Generate and download file
        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const fileName = `${bankName} - ØªÙ‚Ø±ÙŠØ± ${typeText} - ${fromDate} Ø¥Ù„Ù‰ ${toDate}.xlsx`;

        if (typeof saveAs !== 'undefined') {
          saveAs(blob, fileName);
        } else {
          // Fallback for browsers without FileSaver
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
        }

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');

      } catch (error) {
        console.error('Error creating daily Excel file:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel: ' + error.message);
      }
    }

    async function runMonthlyReport(){
      try {
        const month = Number($('#monthSelect').value);
        const year = Number($('#yearInput').value);

        if (!month || !year) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
          return;
        }

        const banks = await listBanks();
        const tbody = $('#monthlyTbody');
        tbody.innerHTML = '';

        let totalDebit = 0;
        let totalCredit = 0;

        for (const bank of banks) {
          const monthStart = monthStartISO(year, month);
          const monthEnd = monthEndISO(year, month);

          const debitTotal = await sumEntries(bank.id, 'debit', monthStart, monthEnd);
          const creditTotal = await sumEntries(bank.id, 'credit', monthStart, monthEnd);
          const netTotal = debitTotal - creditTotal;

          totalDebit += debitTotal;
          totalCredit += creditTotal;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-3 py-2 border border-border text-center">${escapeHtml(bank.name)}</td>
            <td class="px-3 py-2 border border-border text-center">${formatAmount(debitTotal)}</td>
            <td class="px-3 py-2 border border-border text-center">${formatAmount(creditTotal)}</td>
            <td class="px-3 py-2 border border-border text-center ${netTotal >= 0 ? 'text-green-600' : 'text-red-600'}">${formatAmount(netTotal)}</td>
          `;
          tbody.appendChild(row);
        }

        // Update totals
        $('#monthlyDebitTotal').textContent = formatAmount(totalDebit);
        $('#monthlyCreditTotal').textContent = formatAmount(totalCredit);
        $('#monthlyNetTotal').textContent = formatAmount(totalDebit - totalCredit);

        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ');

      } catch (error) {
        console.error('Error running monthly report:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
      }
    }

    async function exportMonthlyReport(){
      try {
        const month = Number($('#monthSelect').value);
        const year = Number($('#yearInput').value);

        if (!month || !year) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
          return;
        }

        const banks = await listBanks();
        const monthName = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'][month - 1];

        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet(`Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthName} ${year}`);

        // Add header info
        ws.getRow(1).values = ['Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ'];
        ws.getRow(2).values = ['Ø§Ù„Ø´Ù‡Ø±:', monthName];
        ws.getRow(3).values = ['Ø§Ù„Ø³Ù†Ø©:', year];
        ws.getRow(4).values = ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', new Date().toLocaleDateString('ar-SA')];

        // Add table headers
        ws.getRow(6).values = ['Ø§Ù„Ø¨Ù†Ùƒ', 'Ø§Ù„Ù…Ø¯ÙŠÙ†', 'Ø§Ù„Ø¯Ø§Ø¦Ù†', 'Ø§Ù„ØµØ§ÙÙŠ'];

        // Style header row
        const headerRow = ws.getRow(6);
        headerRow.eachCell(cell => {
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
          cell.font = { bold: true };
          cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        });

        // Add data rows
        let rowIndex = 7;
        let totalDebit = 0;
        let totalCredit = 0;

        for (const bank of banks) {
          const monthStart = monthStartISO(year, month);
          const monthEnd = monthEndISO(year, month);

          const debitTotal = await sumEntries(bank.id, 'debit', monthStart, monthEnd);
          const creditTotal = await sumEntries(bank.id, 'credit', monthStart, monthEnd);
          const netTotal = debitTotal - creditTotal;

          totalDebit += debitTotal;
          totalCredit += creditTotal;

          ws.getRow(rowIndex).values = [
            bank.name,
            debitTotal,
            creditTotal,
            netTotal
          ];

          // Style data row
          const dataRow = ws.getRow(rowIndex);
          dataRow.eachCell(cell => {
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            if (typeof cell.value === 'number') {
              cell.numFmt = '#,##0.00';
            }
          });

          rowIndex++;
        }

        // Add totals row
        const totalRow = ws.getRow(rowIndex);
        totalRow.values = ['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', totalDebit, totalCredit, totalDebit - totalCredit];
        totalRow.eachCell(cell => {
          cell.font = { bold: true };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF1F5F9' } };
          cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
          if (typeof cell.value === 'number') {
            cell.numFmt = '#,##0.00';
          }
        });

        // Set column widths
        ws.getColumn(1).width = 25;
        ws.getColumn(2).width = 15;
        ws.getColumn(3).width = 15;
        ws.getColumn(4).width = 15;

        // Generate and download file
        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const fileName = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthName} ${year}.xlsx`;

        if (typeof saveAs !== 'undefined') {
          saveAs(blob, fileName);
        } else {
          // Fallback for browsers without FileSaver
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
        }

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­');

      } catch (error) {
        console.error('Error exporting monthly report:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
      }
    }

    async function updateBanksGrid(){
      try {
        const banks = await listBanks();
        const banksGrid = $('#banksGrid');
        banksGrid.innerHTML = '';

        if (banks.length === 0) {
          banksGrid.innerHTML = '<div class="col-span-full text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆÙƒ Ù…ØªØ§Ø­Ø©</div>';
          return;
        }

        for (const bank of banks) {
          const bankCard = document.createElement('div');
          bankCard.className = 'bg-white rounded-xl border border-border p-4 hover:shadow-md transition-shadow';

          // Get bank statistics
          const debitTotal = await sumEntries(bank.id, 'debit', '0000-01-01', '9999-12-31');
          const creditTotal = await sumEntries(bank.id, 'credit', '0000-01-01', '9999-12-31');
          const netBalance = debitTotal - creditTotal;

          bankCard.innerHTML = `
            <div class="text-center mb-3">
              <div class="text-lg font-semibold text-primary mb-1">${escapeHtml(bank.name)}</div>
              <div class="text-sm text-slate-600">${bank.createdAt ? new Date(bank.createdAt).toLocaleDateString('ar-SA') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
            </div>

            <div class="space-y-2 mb-4">
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†:</span>
                <span class="font-medium">${formatAmount(debitTotal)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†:</span>
                <span class="font-medium">${formatAmount(creditTotal)}</span>
              </div>
              <div class="flex justify-between text-sm border-t pt-2">
                <span class="font-semibold">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ:</span>
                <span class="font-semibold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatAmount(netBalance)}</span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button onclick="openBank('${bank.id}', 'debit')" class="px-3 py-2 bg-primary text-white text-sm rounded-md hover:bg-primary-hover transition-colors">
                ğŸ’° ØªØ³ÙˆÙŠØ§Øª (Ù…Ø¯ÙŠÙ†)
              </button>
              <button onclick="openBank('${bank.id}', 'credit')" class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors">
                ğŸ“„ Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø¯Ø§Ø¦Ù†)
              </button>
            </div>
          `;

          banksGrid.appendChild(bankCard);
        }

        console.log('Banks grid updated with', banks.length, 'banks');
      } catch (error) {
        console.error('Error updating banks grid:', error);
        const banksGrid = $('#banksGrid');
        banksGrid.innerHTML = '<div class="col-span-full text-center text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆÙƒ</div>';
      }
    }

    function setSection(name){
      console.log('Setting section to:', name);
      $$('.section').forEach(sec=> sec.classList.add('hidden'));
      const targetSection = $(`section[data-section="${name}"]`);
      if (targetSection) {
        targetSection.classList.remove('hidden');
        // Save current section to localStorage
        localStorage.setItem('currentSection', name);
        console.log('Section shown:', name);
      } else {
        console.error('Section not found:', name);
      }
    }

    // ===============================
    // Rendering tables
    // ===============================
    function renderRows(tbody, rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class=\"px-3 py-2 border-2 border-border text-right\">${escapeHtml(r.description||'')}</td>
          <td class=\"px-3 py-2 border-2 border-border text-center\">${r.dateISO}</td>
          <td class=\"px-3 py-2 border-2 border-border text-right\">${r.amountExpr ? `${escapeHtml(r.amountExpr)} = ` : ''}${formatAmount(r.amount)}</td>
          <td class=\"px-3 py-2 border-2 border-border text-right\">${escapeHtml(r.notes||'')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    async function reloadEntries(type){
      try {
        const search = type==='debit' ? $('#debitSearch').value.trim() : $('#creditSearch').value.trim();
        const from = type==='debit' ? $('#debitFrom').value : $('#creditFrom').value;
        const to = type==='debit' ? $('#debitTo').value : $('#creditTo').value;
        const rows = await listEntriesByBankAndFilters(currentBankId, type, { searchText: search, fromDateISO: from||'0000-01-01', toDateISO: to||'9999-12-31' });
        pagination[type].all = rows;
        pagination[type].page = 0;
        resetAndRenderPage(type);
        const total = rows.reduce((a,r)=> a + Number(r.amount||0), 0);
        (type==='debit'? $('#debitTotal'): $('#creditTotal')).textContent = formatAmount(total);
        console.log(`Reloaded ${type} entries:`, rows.length, 'rows, total:', total);
      } catch (error) {
        console.error(`Error reloading ${type} entries:`, error);
      }
    }

    async function updateDailyTotals(type){
      try {
        const date = type==='debit' ? $('#debitRecDate').value : $('#creditRecDate').value;
        if(!date){ return; }
        const tot = await sumEntries(currentBankId, type, date, date);
        (type==='debit'? $('#debitDayTotal') : $('#creditDayTotal')).value = formatAmount(tot);
        console.log(`Updated daily totals for ${type}:`, tot);
      } catch (error) {
        console.error(`Error updating daily totals for ${type}:`, error);
      }
    }

    async function updateMonthlyTotals(type){
      try {
        console.log(`=== updateMonthlyTotals called for ${type} ===`);

        const month = type==='debit' ? Number($('#debitMonthSelect').value) : Number($('#creditMonthSelect').value);
        const year = type==='debit' ? Number($('#debitYearInput').value) : Number($('#creditYearInput').value);
        
        console.log(`Raw values:`, { month, year, currentBankId });
        
        if(!month || !year){ 
          console.log(`Missing month or year for ${type}:`, { month, year });
          return; 
        }
        
        if(!currentBankId){
          console.log(`No currentBankId for ${type}`);
          return;
        }
        
        console.log(`dayjs available:`, typeof dayjs !== 'undefined');
        console.log(`dayjs month function:`, typeof dayjs().month === 'function');

        const monthStart = monthStartISO(year, month);
        const monthEnd = monthEndISO(year, month);
        console.log(`Date range for ${type}:`, { monthStart, monthEnd });

        const tot = await sumEntries(currentBankId, type, monthStart, monthEnd);
        console.log(`Sum result for ${type}:`, tot);

        const targetElement = type==='debit' ? $('#debitMonthTotal') : $('#creditMonthTotal');
        console.log(`âœ… Target element:`, targetElement);

        targetElement.value = formatAmount(tot);
        console.log(`âœ… Updated monthly totals for ${type}:`, tot);
        console.log(`=== updateMonthlyTotals completed for ${type} ===`);
      } catch (error) {
        console.error(`Error updating monthly totals for ${type}:`, error);
      }
    }

    // ===============================
    // Excel Export using ExcelJS
    // ===============================
    function addInfoHeader(ws, infoPairs){
      let rowIdx = 1;
      for(const [k,v] of infoPairs){
        const row = ws.getRow(rowIdx++);
        row.height = 20;
        row.getCell(1).value = k;
        row.getCell(2).value = v;
        row.getCell(1).alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
        row.getCell(2).alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
        row.getCell(1).fill = { type: 'pattern', pattern:'solid', fgColor: { argb: 'FFE3F2FD' } };
        row.getCell(2).fill = { type: 'pattern', pattern:'solid', fgColor: { argb: 'FFE8F5E9' } };
        row.getCell(1).border = { top:{style:'medium'}, left:{style:'medium'}, bottom:{style:'medium'}, right:{style:'medium'} };
        row.getCell(2).border = { top:{style:'medium'}, left:{style:'medium'}, bottom:{style:'medium'}, right:{style:'medium'} };
        row.font = { bold: true };
      }
      ws.getColumn(1).width = 40;
      ws.getColumn(2).width = 40;
      return rowIdx;
    }

    function styleHeaderRow(row){
      row.height = 20;
      row.eachCell(cell => {
        cell.fill = { type: 'pattern', pattern:'solid', fgColor: { argb: 'FFF1F5F9' } };
        cell.border = { top:{style:'medium'}, left:{style:'medium'}, bottom:{style:'medium'}, right:{style:'medium'} };
        cell.font = { bold: true };
        cell.alignment = { vertical:'middle', horizontal:'center', wrapText: true };
      });
    }

    function styleDataRow(row){
      row.height = 20;
      row.eachCell(cell => {
        cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
        cell.alignment = { vertical:'middle', horizontal:'center', wrapText: true };
        if(typeof cell.value === 'number'){
          cell.numFmt = '#,##0.00';
        }
      });
    }

    async function exportMonthlyExcel(bankName, month, year, agg){
      const wb = new ExcelJS.Workbook();
      const mm = String(month).padStart(2,'0');
      // Debit sheet
      const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName} - ${mm}/${year}`);
      const infoStartRowD = addInfoHeader(wsD, [
        ['Bank', bankName],
        ['Month/Year', `${mm}/${year}`],
        ['Opening Balance', agg.opening],
        ['Total Debit', agg.totalDebit],
        ['Total Credit', agg.totalCredit],
        ['Net Movement', agg.net],
        ['Closing Balance', agg.closing]
      ]);
      let r = infoStartRowD + 1;
      const hdrD = wsD.getRow(r++);
      hdrD.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrD);
      for(const e of agg.debitEntries){
        const row = wsD.getRow(r++);
        row.values = [e.description, e.dateISO, Number(e.amount), e.notes||''];
        styleDataRow(row);
      }

      // Credit sheet
      const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName} - ${mm}/${year}`);
      const infoStartRowC = addInfoHeader(wsC, [
        ['Bank', bankName],
        ['Month/Year', `${mm}/${year}`],
        ['Opening Balance', agg.opening],
        ['Total Debit', agg.totalDebit],
        ['Total Credit', agg.totalCredit],
        ['Net Movement', agg.net],
        ['Closing Balance', agg.closing]
      ]);
      let rc = infoStartRowC + 1;
      const hdrC = wsC.getRow(rc++);
      hdrC.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrC);
      for(const e of agg.creditEntries){
        const row = wsC.getRow(rc++);
        row.values = [e.description, e.dateISO, Number(e.amount), e.notes||''];
        styleDataRow(row);
      }

      const fname = `${bankName} - ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ - ${mm}-${year}.xlsx`;
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fname);
    }

    async function exportAnnualExcel(bankName, fiscalStartYear, rows){
      const wb = new ExcelJS.Workbook();
      const period = `${fiscalStartYear}-${fiscalStartYear+1}`;

      // Flatten entries across months for each type
      const allDebit = [];
      const allCredit = [];
      for(const r of rows){
        for(const e of r.debitEntries){ allDebit.push(e); }
        for(const e of r.creditEntries){ allCredit.push(e); }
      }

      const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName} - ${period}`);
      addInfoHeader(wsD, [['Bank', bankName], ['Fiscal Year', period]]);
      let r1 = 3;
      const hdrD = wsD.getRow(r1++);
      hdrD.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrD);
      for(const e of allDebit){ const row = wsD.getRow(r1++); row.values = [e.description, e.dateISO, Number(e.amount), e.notes||'']; styleDataRow(row); }

      const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName} - ${period}`);
      addInfoHeader(wsC, [['Bank', bankName], ['Fiscal Year', period]]);
      let r2 = 3;
      const hdrC = wsC.getRow(r2++);
      hdrC.values = ['Description','Date','Amount','Notes'];
      styleHeaderRow(hdrC);
      for(const e of allCredit){ const row = wsC.getRow(r2++); row.values = [e.description, e.dateISO, Number(e.amount), e.notes||'']; styleDataRow(row); }

      const fname = `${bankName} - ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ - ${period}.xlsx`;
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fname);
    }

    // ===============================
    // Event handlers and init
    // ===============================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM loaded, starting initialization...');

      try {
        // Check if all required functions are available
        if (typeof dayjs === 'undefined') {
          throw new Error('Day.js library not loaded');
        }

        if (typeof $ === 'undefined') {
          throw new Error('jQuery-like functions not available');
        }

        await openDB();
        console.log('Database opened successfully');
        await refreshBankSelector();
        console.log('Bank selector refreshed');

        // default dates - restore from localStorage or use today
        const today = todayISO();
        const savedDebitDate = localStorage.getItem('debitDate') || today;
        const savedCreditDate = localStorage.getItem('creditDate') || today;
        const savedDebitRecDate = localStorage.getItem('debitRecDate') || today;
        const savedCreditRecDate = localStorage.getItem('creditRecDate') || today;

        $('#debitDate').value = savedDebitDate;
        $('#creditDate').value = savedCreditDate;
        $('#debitRecDate').value = savedDebitRecDate;
        $('#creditRecDate').value = savedCreditRecDate;

        console.log('Dates restored from localStorage:', {
          debitDate: savedDebitDate,
          creditDate: savedCreditDate,
          debitRecDate: savedDebitRecDate,
          creditRecDate: savedCreditRecDate
        });

        // Set current month/year for monthly reconciliation - restore from localStorage or use current
        const now = dayjs();
        const savedDebitMonth = localStorage.getItem('debitMonth') || String(now.month()+1);
        const savedDebitYear = localStorage.getItem('debitYear') || String(now.year());
        const savedCreditMonth = localStorage.getItem('creditMonth') || String(now.month()+1);
        const savedCreditYear = localStorage.getItem('creditYear') || String(now.year());

        $('#debitMonthSelect').value = savedDebitMonth;
        $('#debitYearInput').value = savedDebitYear;
        $('#creditMonthSelect').value = savedCreditMonth;
        $('#creditYearInput').value = savedCreditYear;

        console.log('Monthly reconciliation initialized with:', {
          month: now.month()+1,
          year: now.year()
        });

        // Navigation buttons
        $$('.nav-btn, [data-nav]').forEach(btn => btn.addEventListener('click', (e)=>{
          const target = e.currentTarget.getAttribute('data-nav');
          console.log('Navigation button clicked:', target);
          if(target){
            setSection(target);

            // Update banks grid when returning to home
            if (target === 'home') {
              setTimeout(async () => {
                try {
                  await updateBanksGrid();
                } catch (error) {
                  console.error('Error updating banks grid on home navigation:', error);
                }
              }, 100);
            }

            // Update button styles
            $$('.nav-btn').forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('border', 'border-border', 'bg-white');
            });
            e.currentTarget.classList.remove('border', 'border-border', 'bg-white');
            e.currentTarget.classList.add('bg-primary', 'text-white');
          }
        }));

        // Restore last section from localStorage
        const savedSection = localStorage.getItem('currentSection') || 'home';
        setSection(savedSection);
        console.log('Restored section:', savedSection);

        // Update button styles for restored section
        setTimeout(() => {
          const activeButton = $(`[data-nav="${savedSection}"]`);
          if(activeButton) {
            $$('.nav-btn').forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('border', 'border-border', 'bg-white');
            });
            activeButton.classList.remove('border', 'border-border', 'bg-white');
            activeButton.classList.add('bg-primary', 'text-white');
          }
        }, 100);

        // Load data for current bank if available
        if (currentBankId) {
          console.log('Loading data for current bank:', currentBankId);
          setTimeout(async () => {
            try {
              // Clear existing data first
              $('#debitTableBody').innerHTML = '';
              $('#creditTableBody').innerHTML = '';
              $('#debitTotal').textContent = '0.00';
              $('#creditTotal').textContent = '0.00';

              await reloadEntries('debit');
              await reloadEntries('credit');
              await updateDailyTotals('debit');
              await updateDailyTotals('credit');
              await updateMonthlyTotals('debit');
              await updateMonthlyTotals('credit');
              console.log('Data loaded successfully for bank:', currentBankId);
            } catch (error) {
              console.error('Error loading data for bank:', error);
            }
          }, 200);
        }

        // Attach infinite scroll listeners
        attachInfiniteScroll();

        console.log('Initialization completed successfully');
      } catch (error) {
        console.error('Error during initialization:', error);
        // Show error to user
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: ' + error.message);

        // Try to show basic functionality
        try {
          setSection('home');
          console.log('Basic functionality enabled despite errors');
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
        }
      }

      // Bank selector
      $('#bankSelect').addEventListener('change', async (e)=>{
        try {
          currentBankId = Number(e.target.value);
          const banks = await listBanks();
          currentBankName = (banks.find(b=>b.id===currentBankId)||{}).name || '';

          // Save selected bank to localStorage
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);

          console.log('Bank changed to:', currentBankId, currentBankName);

          // Clear existing data first
          $('#debitTableBody').innerHTML = '';
          $('#creditTableBody').innerHTML = '';
          $('#debitTotal').textContent = '0.00';
          $('#creditTotal').textContent = '0.00';

          // Load new data for selected bank
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');

          console.log('Data reloaded for bank:', currentBankId);

          // Show success message
          showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ùƒ: ${currentBankName}`);

        } catch (error) {
          console.error('Error changing bank:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ù†Ùƒ: ' + error.message);
        }
      });

      // Add Bank modal
      $('#addBankBtn').addEventListener('click', ()=>{ $('#newBankName').value=''; $('#bankModal').classList.remove('hidden'); $('#bankModal').classList.add('flex'); });
      $('#bankCancelBtn').addEventListener('click', ()=>{ $('#bankModal').classList.add('hidden'); $('#bankModal').classList.remove('flex'); });
      $('#bankSaveBtn').addEventListener('click', async ()=>{
        const name = $('#newBankName').value.trim();
        if(!name){ showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ'); return; }
        try{
          console.log('Adding new bank:', name);
          const id = await addBank(name);
          console.log('Bank added with ID:', id);
          await refreshBankSelector();
          $('#bankSelect').value = String(id);
          currentBankId = id; currentBankName = name;

          // Save new bank to localStorage
          localStorage.setItem('currentBankId', String(currentBankId));
          localStorage.setItem('currentBankName', currentBankName);

          $('#bankModal').classList.add('hidden'); $('#bankModal').classList.remove('flex');
          showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ùƒ');
          
          // Clear existing data and load for new bank
          $('#debitTableBody').innerHTML = '';
          $('#creditTableBody').innerHTML = '';
          $('#debitTotal').textContent = '0.00';
          $('#creditTotal').textContent = '0.00';

          // Reload entries for the new bank
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');
        }catch(err){ 
          console.error('Error adding bank:', err);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ùƒ: ' + err.message); 
        }
      });

      // Debit form
      $('#debitForm').addEventListener('submit', async (e)=>{
        e.preventDefault();

        // Check if bank is selected
        if (!currentBankId) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        const description = $('#debitDesc').value.trim();
        const dateISO = $('#debitDate').value;
        const amountExprRaw = $('#debitAmount').value.trim();
        const amount = parseAmountExpression(amountExprRaw);
        const amountExpr = amountExprRaw.includes('+') ? amountExprRaw : '';
        const notes = $('#debitNotes').value.trim();

        if(!description || !dateISO || !(amount>0)){
          showToast('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          return;
        }
        
        try {
          console.log('Adding debit entry:', { bankId: currentBankId, type: 'debit', description, dateISO, amount, notes });
          await addEntry({ bankId: currentBankId, type: 'debit', description, dateISO, amount, notes, amountExpr });
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ (Ù…Ø¯ÙŠÙ†)');
          $('#debitForm').reset();
          // Restore saved date after reset
          const savedDebitDate = localStorage.getItem('debitDate') || todayISO();
          $('#debitDate').value = savedDebitDate;
          await reloadEntries('debit');
          await updateDailyTotals('debit');
          await updateMonthlyTotals('debit');
          console.log('Debit entry added successfully');
        } catch (error) {
          console.error('Error adding debit entry:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯: ' + error.message);
        }
      });

      // Credit form
      $('#creditForm').addEventListener('submit', async (e)=>{
        e.preventDefault();

        // Check if bank is selected
        if (!currentBankId) {
          showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        const description = $('#creditDesc').value.trim();
        const dateISO = $('#creditDate').value;
        const amountExprRaw = $('#creditAmount').value.trim();
        const amount = parseAmountExpression(amountExprRaw);
        const amountExpr = amountExprRaw.includes('+') ? amountExprRaw : '';
        const notes = $('#creditNotes').value.trim();

        if(!description || !dateISO || !(amount>0)){
          showToast('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          return;
        }
        
        try {
          console.log('Adding credit entry:', { bankId: currentBankId, type: 'credit', description, dateISO, amount, notes });
          await addEntry({ bankId: currentBankId, type: 'credit', description, dateISO, amount, notes, amountExpr });
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ (Ø¯Ø§Ø¦Ù†)');
          $('#creditForm').reset();
          // Restore saved date after reset
          const savedCreditDate = localStorage.getItem('creditDate') || todayISO();
          $('#creditDate').value = savedCreditDate;
          await reloadEntries('credit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('credit');
          console.log('Credit entry added successfully');
        } catch (error) {
          console.error('Error adding credit entry:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯: ' + error.message);
        }
      });

      // Filters
      $('#debitFilterBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await reloadEntries('debit'); });
      $('#debitClearBtn').addEventListener('click', async (e)=>{ e.preventDefault(); $('#debitSearch').value=''; $('#debitFrom').value=''; $('#debitTo').value=''; await reloadEntries('debit'); });
      $('#creditFilterBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await reloadEntries('credit'); });
            $('#creditClearBtn').addEventListener('click', async (e)=>{ e.preventDefault(); $('#creditSearch').value=''; $('#creditFrom').value=''; $('#creditTo').value=''; await reloadEntries('credit'); });

      // Reports page listeners
      $('#reportFilterBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await reloadEntries('debit'); await reloadEntries('credit'); });
      $('#reportClearBtn').addEventListener('click', async (e)=>{ e.preventDefault(); $('#reportSearch').value=''; $('#reportFrom').value=''; $('#reportTo').value=''; });
      $('#reportExportDailyBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await exportDailyExcelDualSheets(); });
      $('#reportExportMonthlyBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await exportMonthlyFromReportSelectors(); });
      $('#reportExportAnnualBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await exportAnnualSummary(); });
      bindReportControls();
      
      // Live search with debounce
      const debouncedReloadDebit = debounce(()=> reloadEntries('debit'), 300);
      const debouncedReloadCredit = debounce(()=> reloadEntries('credit'), 300);
      $('#debitSearch').addEventListener('input', debouncedReloadDebit);
      $('#debitFrom').addEventListener('change', debouncedReloadDebit);
      $('#debitTo').addEventListener('change', debouncedReloadDebit);
      $('#creditSearch').addEventListener('input', debouncedReloadCredit);
      $('#creditFrom').addEventListener('change', debouncedReloadCredit);
      $('#creditTo').addEventListener('change', debouncedReloadCredit);

      // New buttons - Debit




      // New buttons - Credit




      // Auto-update date fields when form dates change
      $('#debitDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#debitRecDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('debitDate', e.target.value);
          localStorage.setItem('debitRecDate', e.target.value);

          // Update filters to show only entries for selected date
          $('#debitFrom').value = e.target.value;
          $('#debitTo').value = e.target.value;

          // Reload entries and update totals
          if (currentBankId) {
            reloadEntries('debit');
            updateDailyTotals('debit');
            updateMonthlyTotals('debit');
          }
        }
      });
      
      $('#creditDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#creditRecDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('creditDate', e.target.value);
          localStorage.setItem('creditRecDate', e.target.value);

          // Update filters to show only entries for selected date
          $('#creditFrom').value = e.target.value;
          $('#creditTo').value = e.target.value;

          // Reload entries and update totals
          if (currentBankId) {
            reloadEntries('credit');
            updateDailyTotals('credit');
            updateMonthlyTotals('credit');
          }
        }
      });

      // Daily reconciliation - Initialize default values - RESET ON REFRESH
      $('#debitRecDate').value = todayISO();
      $('#creditRecDate').value = todayISO();
      $('#debitBankBalance').value = '';
      $('#creditBankBalance').value = '';
      $('#debitDayTotal').value = '0.00';
      $('#creditDayTotal').value = '0.00';
      $('#debitMatchResult').textContent = '';
      $('#creditMatchResult').textContent = '';
      
      // Monthly reconciliation - RESET ON REFRESH
      $('#debitMonthBankBalance').value = '';
      $('#creditMonthBankBalance').value = '';
      $('#debitMonthTotal').value = '0.00';
      $('#creditMonthTotal').value = '0.00';
      $('#debitMonthMatchResult').textContent = '';
      $('#creditMonthMatchResult').textContent = '';
      
      // Daily reconciliation event listeners
      $('#debitRecDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#debitDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('debitRecDate', e.target.value);
          localStorage.setItem('debitDate', e.target.value);
          if (currentBankId) {
            // Update filters to show only entries for selected date
            $('#debitFrom').value = e.target.value;
            $('#debitTo').value = e.target.value;
            // Reload entries and update totals
            reloadEntries('debit');
            updateDailyTotals('debit');
            updateMonthlyTotals('debit');
          }
        }
      });
      $('#creditRecDate').addEventListener('change', (e)=>{
        if(e.target.value) {
          $('#creditDate').value = e.target.value;
          // Save date to localStorage
          localStorage.setItem('creditRecDate', e.target.value);
          localStorage.setItem('creditDate', e.target.value);
          if (currentBankId) {
            // Update filters to show only entries for selected date
            $('#creditFrom').value = e.target.value;
            $('#creditTo').value = e.target.value;
            // Reload entries and update totals
            reloadEntries('credit');
            updateDailyTotals('credit');
            updateMonthlyTotals('credit');
          }
        }
      });

      $('#debitMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          const date = $('#debitRecDate').value;
          const bal = Number($('#debitBankBalance').value);

          if (!date) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
            return;
          }

          if (!bal || bal <= 0) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ');
            return;
          }

          console.log('Daily reconciliation for debit:', { date, balance: bal, currentBankId });

          // Calculate daily total
          const total = await sumEntries(currentBankId, 'debit', date, date);
          $('#debitDayTotal').value = formatAmount(total);

          // Calculate difference
          const diff = bal - total;
          $('#debitMatchResult').textContent = diff === 0 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚' : `âŒ Ø§Ù„ÙØ±Ù‚: ${formatAmount(diff)}`;

          // Save reconciliation
          await upsertReconciliation(currentBankId, date, bal);
          console.log('Daily reconciliation saved for debit');

          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©');

        } catch (error) {
          console.error('Error in daily reconciliation for debit:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ' + error.message);
        }
      });

      $('#creditMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          const date = $('#creditRecDate').value;
          const bal = Number($('#creditBankBalance').value);

          if (!date) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
            return;
          }

          if (!bal || bal <= 0) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ');
            return;
          }

          console.log('Daily reconciliation for credit:', { date, balance: bal, currentBankId });

          // Calculate daily total
          const total = await sumEntries(currentBankId, 'credit', date, date);
          $('#creditDayTotal').value = formatAmount(total);

          // Calculate difference
          const diff = bal - total;
          $('#creditMatchResult').textContent = diff === 0 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚' : `âŒ Ø§Ù„ÙØ±Ù‚: ${formatAmount(diff)}`;

          // Save reconciliation
          await upsertReconciliation(currentBankId, date, bal);
          console.log('Daily reconciliation saved for credit');

          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©');

        } catch (error) {
          console.error('Error in daily reconciliation for credit:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ' + error.message);
        }
      });

      // Monthly reconciliation - Initialize default values
      console.log('About to initialize monthly reconciliation, dayjs available:', typeof dayjs !== 'undefined');
      if (typeof dayjs === 'undefined') {
        console.error('dayjs is not available during initialization!');
        // Set default values
        $('#debitMonthSelect').value = '1';
        $('#debitYearInput').value = '2024';
        $('#creditMonthSelect').value = '1';
        $('#creditYearInput').value = '2024';
      } else {
        const now = dayjs();
        console.log('Initializing monthly reconciliation with:', {
          month: now.month() + 1,
          year: now.year(),
          dayjsAvailable: typeof dayjs !== 'undefined'
        });

        $('#debitMonthSelect').value = String(now.month() + 1);
        $('#debitYearInput').value = String(now.year());
        $('#creditMonthSelect').value = String(now.month() + 1);
        $('#creditYearInput').value = String(now.year());
      }
      
      // Initialize monthly totals after setting values
      setTimeout(() => {
        updateMonthlyTotals('debit');
        updateMonthlyTotals('credit');
      }, 100);
      
      // Monthly reconciliation event listeners - Simple approach
      $('#debitMonthSelect').addEventListener('change', (e)=>{
        localStorage.setItem('debitMonth', e.target.value);
        if (currentBankId) {
          updateMonthlyTotals('debit');
        }
      });
      
      $('#debitYearInput').addEventListener('change', (e)=>{
        localStorage.setItem('debitYear', e.target.value);
        if (currentBankId) {
          updateMonthlyTotals('debit');
        }
      });
      
      $('#creditMonthSelect').addEventListener('change', (e)=>{
        localStorage.setItem('creditMonth', e.target.value);
        if (currentBankId) {
          updateMonthlyTotals('credit');
        }
      });

      $('#creditYearInput').addEventListener('change', (e)=>{
        localStorage.setItem('creditYear', e.target.value);
        if (currentBankId) {
          updateMonthlyTotals('credit');
        }
      });

      // Monthly report
      $('#monthlyRunBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await runMonthlyReport(); });
      $('#monthlyExportBtn').addEventListener('click', async (e)=>{ e.preventDefault(); await exportMonthlyReportMulti(); });

      $('#debitMonthMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          const month = Number($('#debitMonthSelect').value);
          const year = Number($('#debitYearInput').value);
          const bal = Number($('#debitMonthBankBalance').value);

          if (!month || !year) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
          }

          if (!bal || bal <= 0) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ');
            return;
          }

          console.log('Monthly reconciliation for debit:', { month, year, balance: bal, currentBankId });

          // Calculate monthly total
          const total = await sumEntries(currentBankId, 'debit', monthStartISO(year, month), monthEndISO(year, month));
          $('#debitMonthTotal').value = formatAmount(total);

          // Calculate difference
          const diff = bal - total;
          $('#debitMonthMatchResult').textContent = diff === 0 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚' : `âŒ Ø§Ù„ÙØ±Ù‚: ${formatAmount(diff)}`;

          // Save monthly reconciliation
          const monthEnd = monthEndISO(year, month);
          await upsertReconciliation(currentBankId, monthEnd, bal);
          console.log('Monthly reconciliation saved for debit');

          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©');

        } catch (error) {
          console.error('Error in monthly reconciliation for debit:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©: ' + error.message);
        }
      });

      $('#creditMonthMatchBtn').addEventListener('click', async ()=>{
        try {
          if (!currentBankId) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
            return;
          }

          const month = Number($('#creditMonthSelect').value);
          const year = Number($('#creditYearInput').value);
          const bal = Number($('#creditMonthBankBalance').value);

          if (!month || !year) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
          }

          if (!bal || bal <= 0) {
            showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯ ÙƒØ´Ù Ø§Ù„Ø¨Ù†Ùƒ');
            return;
          }

          console.log('Monthly reconciliation for credit:', { month, year, balance: bal, currentBankId });

          // Calculate monthly total
          const total = await sumEntries(currentBankId, 'credit', monthStartISO(year, month), monthEndISO(year, month));
          $('#creditMonthTotal').value = formatAmount(total);

          // Calculate difference
          const diff = bal - total;
          $('#creditMonthMatchResult').textContent = diff === 0 ? 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚' : `âŒ Ø§Ù„ÙØ±Ù‚: ${formatAmount(diff)}`;

          // Save monthly reconciliation
          const monthEnd = monthEndISO(year, month);
          await upsertReconciliation(currentBankId, monthEnd, bal);
          console.log('Monthly reconciliation saved for credit');

          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©');

        } catch (error) {
          console.error('Error in monthly reconciliation for credit:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©: ' + error.message);
        }
      });

      // Monthly report initialization
      const now2 = dayjs();
      $('#monthSelect').value = String(now2.month()+1);
      $('#yearInput').value = String(now2.year());

      // Initial load - Wait a bit for everything to be ready
      setTimeout(async () => {
        try {
          await reloadEntries('debit');
          await reloadEntries('credit');
          await updateDailyTotals('debit');
          await updateDailyTotals('credit');
          await updateMonthlyTotals('debit');
          await updateMonthlyTotals('credit');
          console.log('Initial load completed successfully');
        } catch (error) {
          console.error('Error during initial load:', error);
        }
      }, 500);
    });

    function addTableWithRtl(ws, headers, rows, startRow){
      ws.views = [{ rightToLeft: true }];
      let r = startRow;
      const hdr = ws.getRow(r++);
      hdr.values = headers; // keep order as UI: Ø¨ÙŠØ§Ù†ØŒ ØªØ§Ø±ÙŠØ®ØŒ Ù…Ø¨Ù„ØºØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      styleHeaderRow(hdr);
      for(const rowData of rows){
        const row = ws.getRow(r++);
        // Assign cells individually to support formulas
        for(let c=0;c<headers.length;c++){
          const v = rowData[c];
          const cell = row.getCell(c+1);
          if (typeof v === 'string' && v.startsWith('=')){
            // If value is string like '=100+50', write as formula without the leading '='
            cell.value = { formula: v.slice(1) };
            cell.numFmt = '#,##0.00';
          } else {
            cell.value = v;
            if (typeof v === 'number'){ cell.numFmt = '#,##0.00'; }
          }
        }
        styleDataRow(row);
      }
      // Set all column widths to 40
      for (let c = 1; c <= headers.length; c++) { ws.getColumn(c).width = 40; }
      ws.autoFilter = { from: { row: startRow, column: 1 }, to: { row: r-1, column: headers.length } };
      return r;
    }

    async function exportDailyExcelDualSheets(){
      try {
        if (!currentBankId) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
        const fromDate = $('#debitFrom').value || $('#creditFrom').value;
        const toDate = $('#debitTo').value || $('#creditTo').value;
        if (!fromDate || !toDate) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®'); return; }

        const [debitEntries, creditEntries] = await Promise.all([
          listEntriesByBankAndFilters(currentBankId, 'debit', { fromDateISO: fromDate, toDateISO: toDate }),
          listEntriesByBankAndFilters(currentBankId, 'credit', { fromDateISO: fromDate, toDateISO: toDate })
        ]);
        if (debitEntries.length + creditEntries.length === 0) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯'); return; }

        const wb = new ExcelJS.Workbook();
        const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const tDebit = debitEntries.reduce((s,e)=> s + Number(e.amount||0), 0);
        const tCredit = creditEntries.reduce((s,e)=> s + Number(e.amount||0), 0);

        // Debit sheet (RTL order: Notes, Amount, Date, Description)
        const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName}`);
        let rD = addInfoHeader(wsD, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ù…Ù† ØªØ§Ø±ÙŠØ®', fromDate], ['Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®', toDate], ['Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯', debitEntries.length], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', tDebit]]);
        rD += 1;
        addTableWithRtl(wsD, ['Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], debitEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rD);
        wsD.getColumn(1).width = 40;
        wsD.getColumn(2).width = 40;
        wsD.getColumn(3).width = 40;
        wsD.getColumn(4).width = 40

        // Credit sheet
        const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName}`);
        let rC = addInfoHeader(wsC, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ù…Ù† ØªØ§Ø±ÙŠØ®', fromDate], ['Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®', toDate], ['Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯', creditEntries.length], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', tCredit]]);
        rC += 1;
        addTableWithRtl(wsC, ['Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], creditEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rC);
        wsC.getColumn(1).width = 40; wsC.getColumn(2).width = 40; wsC.getColumn(3).width = 40; wsC.getColumn(4).width = 40;

        const buf = await wb.xlsx.writeBuffer();
        const fileName = `${bankName} - ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${fromDate} Ø¥Ù„Ù‰ ${toDate}.xlsx`;
        saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        console.error(err); showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ');
      }
    }

    async function exportMonthlyReportMulti(){
      try {
        const month = Number($('#monthSelect').value);
        const year = Number($('#yearInput').value);
        if (!month || !year) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©'); return; }
        const banks = await listBanks();
        const monthStart = monthStartISO(year, month);
        const monthEnd = monthEndISO(year, month);
        const monthName = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'][month-1];

        const wb = new ExcelJS.Workbook();

        // Summary sheet per bank
        const wsS = wb.addWorksheet(`Ù…Ù„Ø®Øµ - ${monthName} ${year}`);
        let rs = addInfoHeader(wsS, [['Ø§Ù„Ø´Ù‡Ø±', monthName], ['Ø§Ù„Ø³Ù†Ø©', year]]); rs += 1;
        const summaryRows = [];
        for (const bank of banks){
          const d = await sumEntries(bank.id, 'debit', monthStart, monthEnd);
          const c = await sumEntries(bank.id, 'credit', monthStart, monthEnd);
          summaryRows.push([bank.name, d, c, d - c]);
        }
        addTableWithRtl(wsS, ['Ø§Ù„Ø¨Ù†Ùƒ','Ø§Ù„Ù…Ø¯ÙŠÙ†','Ø§Ù„Ø¯Ø§Ø¦Ù†','Ø§Ù„ØµØ§ÙÙŠ'], summaryRows, rs);
        wsS.getColumn(1).width = 40; wsS.getColumn(2).width = 40; wsS.getColumn(3).width = 40; wsS.getColumn(4).width = 40;

        // Per-bank detail: debit and credit sheets
        for (const bank of banks){
          const [debitEntries, creditEntries] = await Promise.all([
            listEntriesByBankAndFilters(bank.id, 'debit', { fromDateISO: monthStart, toDateISO: monthEnd }),
            listEntriesByBankAndFilters(bank.id, 'credit', { fromDateISO: monthStart, toDateISO: monthEnd })
          ]);
          const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bank.name}`);
          let rd = addInfoHeader(wsD, [['Ø§Ù„Ø¨Ù†Ùƒ', bank.name], ['Ø§Ù„Ø´Ù‡Ø±', monthName], ['Ø§Ù„Ø³Ù†Ø©', year], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', debitEntries.reduce((s,e)=> s+Number(e.amount||0),0)]]); rd += 1;
          addTableWithRtl(wsD, ['Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], debitEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rd);
          wsD.getColumn(1).width = 40; wsD.getColumn(2).width = 40; wsD.getColumn(3).width = 40; wsD.getColumn(4).width = 40;

          const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bank.name}`);
          let rc = addInfoHeader(wsC, [['Ø§Ù„Ø¨Ù†Ùƒ', bank.name], ['Ø§Ù„Ø´Ù‡Ø±', monthName], ['Ø§Ù„Ø³Ù†Ø©', year], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', creditEntries.reduce((s,e)=> s+Number(e.amount||0),0)]]); rc += 1;
          addTableWithRtl(wsC, ['Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], creditEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rc);
          wsC.getColumn(1).width = 40; wsC.getColumn(2).width = 40; wsC.getColumn(3).width = 40; wsC.getColumn(4).width = 40;
        }

        const buf = await wb.xlsx.writeBuffer();
        const fileName = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthName} ${year}.xlsx`;
        saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        console.error(err); showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ');
      }
    }

    function monthNameAr(n){
      const arr = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      return arr[n-1] || '';
    }

    async function exportMonthlyForCurrentBank(type){
      if (!currentBankId) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      // infer month/year from the form date of the current section
      const dateStr = type==='debit' ? ($('#debitDate').value || $('#debitFrom').value) : ($('#creditDate').value || $('#creditFrom').value);
      const d = dateStr ? new Date(dateStr+'T00:00:00') : new Date();
      const year = d.getFullYear();
      const month = d.getMonth()+1; // 1-12
      const monthStart = monthStartISO(year, month);
      const monthEnd = monthEndISO(year, month);

      const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const wb = new ExcelJS.Workbook();
      const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName}`); wsD.views = [{ rightToLeft: true }];
      const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName}`); wsC.views = [{ rightToLeft: true }];

      // fetch rows
      const [debitEntries, creditEntries] = await Promise.all([
        listEntriesByBankAndFilters(currentBankId, 'debit', { fromDateISO: monthStart, toDateISO: monthEnd }),
        listEntriesByBankAndFilters(currentBankId, 'credit', { fromDateISO: monthStart, toDateISO: monthEnd })
      ]);

      // headers
      let rd = addInfoHeader(wsD, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ø§Ù„Ø´Ù‡Ø±', monthNameAr(month)], ['Ø§Ù„Ø³Ù†Ø©', year]]); rd += 1;
      addTableWithRtl(wsD, ['Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], debitEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rd);

      let rc = addInfoHeader(wsC, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ø§Ù„Ø´Ù‡Ø±', monthNameAr(month)], ['Ø§Ù„Ø³Ù†Ø©', year]]); rc += 1;
      addTableWithRtl(wsC, ['Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], creditEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rc);

      const buf = await wb.xlsx.writeBuffer();
      const fileName = `${bankName}  Ø´Ù‡Ø± ${month} (${monthNameAr(month)}) ${year}.xlsx`;
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§ÙƒØ³Ù„ Ø´Ù‡Ø±ÙŠ');
    }

    const FISCAL_KEY = 'fiscalStartYear';
    function getDefaultFiscalStartYear(){
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth()+1; // 1..12
      // Fiscal year starts 1/7: if current before July, fiscalStartYear = y-1 else y
      return (m < 7) ? (y-1) : y;
    }
    function fiscalMonthStartISO(fiscalStartYear, month1to12){
      // Map calendar month to target within fiscal year range; we will use actual calendar month boundaries
      return monthStartISO(fiscalStartYear + (month1to12>=7?0:1), month1to12);
    }
    function fiscalStartISO(fiscalStartYear){ return monthStartISO(fiscalStartYear, 7); }
    function fiscalEndISO(fiscalStartYear){ return monthEndISO(fiscalStartYear+1, 6); }

    function loadFiscalYear(){
      let fy = Number(localStorage.getItem(FISCAL_KEY)||'');
      if(!fy){ fy = getDefaultFiscalStartYear(); localStorage.setItem(FISCAL_KEY, String(fy)); }
      $('#fiscalStartYearInput').value = String(fy);
      return fy;
    }

    function saveFiscalYear(v){ localStorage.setItem(FISCAL_KEY, String(v)); }

    async function exportMonthlyFiscalYTD(){
      if (!currentBankId) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const fy = Number($('#fiscalStartYearInput').value||getDefaultFiscalStartYear());
      const toMonth = Number($('#reportToMonth').value||((new Date()).getMonth()+1));
      const startISO = fiscalStartISO(fy);
      const endISO = monthEndISO(toMonth>=7? fy : fy+1, toMonth);

      const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const wb = new ExcelJS.Workbook();
      const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName}`); wsD.views = [{ rightToLeft: true }];
      const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName}`); wsC.views = [{ rightToLeft: true }];

      const [debitEntries, creditEntries] = await Promise.all([
        listEntriesByBankAndFilters(currentBankId, 'debit', { fromDateISO: startISO, toDateISO: endISO }),
        listEntriesByBankAndFilters(currentBankId, 'credit', { fromDateISO: startISO, toDateISO: endISO })
      ]);

      let rd = addInfoHeader(wsD, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©', startISO], ['Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©', endISO]]); rd += 1;
      addTableWithRtl(wsD, ['Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], debitEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rd);

      let rc = addInfoHeader(wsC, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©', startISO], ['Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©', endISO]]); rc += 1;
      addTableWithRtl(wsC, ['Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], creditEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rc);

      const mName = monthNameAr(toMonth);
      const fileName = `${bankName}  Ø­ØªÙ‰ Ø´Ù‡Ø± ${toMonth} (${mName}) ${fy}/${fy+1}.xlsx`;
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯');
    }



    async function upsertOpeningBalance(bankId, openDateISO, amount, label){
      const positive = amount >= 0;
      const absAmount = Math.abs(amount);
      if (useLocalStorage){
        const entries = JSON.parse(localStorage.getItem('entries')||'[]');
        const idx = entries.findIndex(e => e.bankId===bankId && e.dateISO===openDateISO && String(e.description||'').includes(label));
        if (idx >= 0){ entries[idx].type = positive ? 'debit' : 'credit'; entries[idx].amount = absAmount; }
        else { entries.push({ id: Date.now(), bankId, type: positive ? 'debit' : 'credit', description: label, dateISO: openDateISO, amount: absAmount, notes: '', createdAt: new Date().toISOString() }); }
        localStorage.setItem('entries', JSON.stringify(entries));
        return true;
      } else {
        const db = await openDB();
        const t = db.transaction(['entries'], 'readwrite');
        const s = t.objectStore('entries');
        const idx = s.index('by_bankId_date');
        const matches = [];
        await new Promise((resolve,reject)=>{ const req = idx.openCursor(IDBKeyRange.only([bankId, openDateISO])); req.onsuccess = (ev)=>{ const cur = ev.target.result; if(cur){ const v=cur.value; if(String(v.description||'').includes(label)){ matches.push(v); } cur.continue(); } else resolve(); }; req.onerror=()=>reject(req.error); });
        if (matches.length > 0){ const v = matches[0]; v.type = positive ? 'debit' : 'credit'; v.amount = absAmount; await new Promise((res,rej)=>{ const r=s.put(v); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        else { await new Promise((res,rej)=>{ const r=s.add({ bankId, type: positive ? 'debit' : 'credit', description: label, dateISO: openDateISO, amount: absAmount, notes:'', createdAt: new Date().toISOString() }); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        await new Promise((res,rej)=>{ t.oncomplete=()=>res(); t.onerror=()=>rej(t.error); });
        return true;
      }
    }

    async function rolloverFiscalYear(){
      try{
        if (!currentBankId){ showToast('Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
        // fiscal-year checks removed
        if (!confirm('ØªØ£ÙƒÙŠØ¯ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.')){ return; }
        const fy = Number($('#fiscalStartYearInput').value||getDefaultFiscalStartYear());
        const prevStart = fiscalStartISO(fy);
        const prevEnd = fiscalEndISO(fy);
        const totalDebit = await sumEntries(currentBankId, 'debit', prevStart, prevEnd);
        const totalCredit = await sumEntries(currentBankId, 'credit', prevStart, prevEnd);
        const closing = totalDebit - totalCredit;
        const nextFY = fy + 1;
        const openDate = monthStartISO(nextFY, 7);
        const label = `Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ ${fy}/${nextFY}`;
        // archive & clear (existing logic above)
        if (closing !== 0){ await upsertOpeningBalance(currentBankId, openDate, closing, label); }
        $('#fiscalStartYearInput').value = String(nextFY);
        const fromISO = fiscalStartISO(nextFY); const toISO = fiscalEndISO(nextFY);
        $('#headerFromDate').value = fromISO; $('#headerToDate').value = toISO;
        lockUI(true);
        showToast('ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø³Ù†Ø©. ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø­ØªÙ‰ ÙØªØ­ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        await populateFiscalViewSelector();
      } catch(err){ console.error(err); showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø³Ù†Ø©'); }
    }

    // ... existing code ...
      // Reports page listeners
      on('#reportFilterBtn','click', async (e)=>{ e.preventDefault(); await reloadEntries('debit'); await reloadEntries('credit'); });
              on('#reportClearBtn','click', async (e)=>{ e.preventDefault(); const f=$('#reportFrom'); const t=$('#reportTo'); const s=$('#reportSearch'); if(s) s.value=''; if(f) f.value=''; if(t) t.value=''; });
      on('#reportExportDailyBtn','click', async (e)=>{ e.preventDefault(); await exportDailyExcelDualSheets(); });
      on('#reportExportMonthlyBtn','click', async (e)=>{ e.preventDefault(); await exportMonthlyFromReportSelectors(); });
      on('#fiscalStartYearInput','change', (e)=>{ const v = Number(e.target.value||getDefaultFiscalStartYear()); saveFiscalYear(v); });
      // removed rollover listener

      // Live search with debounce
// ... existing code ...
      // After UI init
      // removed fiscal-year init
// ... existing code ...
    async function listArchivedFiscalYears(bankId){
      try{
        if (useLocalStorage){
          const arch = JSON.parse(localStorage.getItem('archives')||'[]');
          const set = new Set();
          for(const a of arch){ if(a.bankId===bankId) set.add(a.fiscalStartYear); }
          return Array.from(set).sort((a,b)=>b-a);
        } else {
          const db = await openDB();
          const t = db.transaction(['archives']);
          const s = t.objectStore('archives');
          const idx = s.index('by_bankId_fy');
          const fYears = new Set();
          await new Promise((resolve,reject)=>{
            const rng = IDBKeyRange.bound([bankId, -Infinity],[bankId, Infinity]);
            const req = idx.openCursor(rng);
            req.onsuccess = (ev)=>{ const cur = ev.target.result; if(cur){ fYears.add(cur.value.fiscalStartYear); cur.continue(); } else resolve(); }
            req.onerror = ()=> reject(req.error);
          });
          return Array.from(fYears).sort((a,b)=>b-a);
        }
      }catch(err){ console.error(err); return []; }
    }

    async function populateFiscalViewSelector(){
      const sel = $('#viewFiscalSelect');
      sel.innerHTML = '';
      const optNow = document.createElement('option'); optNow.value = 'current'; optNow.textContent = 'Ø§Ù„Ø­Ø§Ù„ÙŠØ©'; sel.appendChild(optNow);
      if (!currentBankId) return;
      const years = await listArchivedFiscalYears(currentBankId);
      for(const y of years){ const o = document.createElement('option'); o.value = String(y); o.textContent = `${y}/${y+1}`; sel.appendChild(o); }
    }

    async function switchToFiscalYear(targetFy){
      if (!currentBankId){ showToast('Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      if (targetFy==='current'){ await reloadEntries('debit'); await reloadEntries('credit'); return; }
      const fy = Number(targetFy);
      // Move current active entries to archives (under current fiscal start), then bring selected FY from archives back to entries
      const currentFy = Number($('#fiscalStartYearInput').value||getDefaultFiscalStartYear());
      if (!useLocalStorage){
        const db = await openDB();
        const t = db.transaction(['entries','archives'], 'readwrite');
        const entriesStore = t.objectStore('entries');
        const idx = entriesStore.index('by_bankId_date');
        const cStart = fiscalStartISO(currentFy); const cEnd = fiscalEndISO(currentFy);
        const toMoveOut = [];
        await new Promise((resolve,reject)=>{ const req = idx.openCursor(IDBKeyRange.bound([currentBankId,cStart],[currentBankId,cEnd])); req.onsuccess=(ev)=>{ const cur=ev.target.result; if(cur){ toMoveOut.push(cur.value); cur.continue(); } else resolve(); }; req.onerror=()=>reject(req.error); });
        const archives = t.objectStore('archives');
        for(const e of toMoveOut){ await new Promise((res,rej)=>{ const r=archives.add({ ...e, fiscalStartYear: currentFy }); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        for(const e of toMoveOut){ await new Promise((res,rej)=>{ const r=entriesStore.delete(e.id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        // Bring selected FY from archives
        const idxA = archives.index('by_bankId_fy');
        const toBring = [];
        await new Promise((resolve,reject)=>{ const req = idxA.openCursor(IDBKeyRange.only([currentBankId, fy])); req.onsuccess=(ev)=>{ const cur=ev.target.result; if(cur){ toBring.push(cur.value); cur.continue(); } else resolve(); }; req.onerror=()=>reject(req.error); });
        for(const a of toBring){ const {id: _id, fiscalStartYear, ...rest} = a; await new Promise((res,rej)=>{ const r=entriesStore.add(rest); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); await new Promise((res,rej)=>{ const r=archives.delete(a.id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        await new Promise((res,rej)=>{ t.oncomplete=()=>res(); t.onerror=()=>rej(t.error); });
      } else {
        const entries = JSON.parse(localStorage.getItem('entries')||'[]');
        const arch = JSON.parse(localStorage.getItem('archives')||'[]');
        const cStart = fiscalStartISO(currentFy); const cEnd = fiscalEndISO(currentFy);
        const remain = []; const moved = [];
        for(const e of entries){ if(e.bankId===currentBankId && e.dateISO>=cStart && e.dateISO<=cEnd){ moved.push({...e, fiscalStartYear: currentFy}); } else { remain.push(e); } }
        const bring = []; const keep = [];
        for(const a of arch){ if(a.bankId===currentBankId && a.fiscalStartYear===fy){ bring.push(a); } else { keep.push(a); } }
        for(const b of bring){ const {id: _id, fiscalStartYear, ...rest} = b; remain.push(rest); }
        localStorage.setItem('archives', JSON.stringify(keep.concat(moved)));
        localStorage.setItem('entries', JSON.stringify(remain));
      }
      // Update fiscal year input to selected and refresh
      $('#fiscalStartYearInput').value = String(fy);
      saveFiscalYear(fy);
      await reloadEntries('debit'); await reloadEntries('credit');
      showToast(`ØªÙ… ÙØªØ­ Ø³Ù†Ø© ${fy}/${fy+1}`);
    }

    // ... existing code ...
                  on('#reportExportMonthlyBtn','click', async (e)=>{ e.preventDefault(); await exportMonthlyFromReportSelectors(); });

      // removed fiscal-year init
// ... existing code ...

    function deriveFiscalStartYearFromDateISO(dateISO){
      const [y,m] = [Number(dateISO.slice(0,4)), Number(dateISO.slice(5,7))];
      return m >= 7 ? y : (y-1);
    }

    async function listFiscalYears(bankId){
      const years = new Set();
      // from archives
      try{
        if (!useLocalStorage){
          const db = await openDB();
          if (db !== 'localStorage' && db.objectStoreNames.contains('archives')){
            const t = db.transaction(['archives']);
            const s = t.objectStore('archives');
            const idx = s.index('by_bankId_fy');
            await new Promise((resolve)=>{
              const req = idx.openCursor(IDBKeyRange.bound([bankId,-Infinity],[bankId,Infinity]));
              req.onsuccess = (ev)=>{ const cur=ev.target.result; if(cur){ years.add(cur.value.fiscalStartYear); cur.continue(); } else resolve(); };
              req.onerror = ()=> resolve();
            });
          }
        } else {
          const arch = JSON.parse(localStorage.getItem('archives')||'[]');
          for(const a of arch){ if(a.bankId===bankId){ years.add(Number(a.fiscalStartYear)); } }
        }
      }catch(e){ console.warn('List fiscal years (archives) error', e); }
      // from active entries
      try{
        if (!useLocalStorage){
          const db = await openDB();
          const t = db.transaction(['entries']);
          const s = t.objectStore('entries');
          const idx = s.index('by_bankId_date');
          await new Promise((resolve)=>{
            const req = idx.openCursor(IDBKeyRange.bound([bankId,'0000-01-01'],[bankId,'9999-12-31']));
            req.onsuccess = (ev)=>{ const cur=ev.target.result; if(cur){ const v=cur.value; years.add(deriveFiscalStartYearFromDateISO(v.dateISO)); cur.continue(); } else resolve(); };
            req.onerror = ()=> resolve();
          });
        } else {
          const entries = JSON.parse(localStorage.getItem('entries')||'[]');
          for(const e of entries){ if(e.bankId===bankId){ years.add(deriveFiscalStartYearFromDateISO(e.dateISO)); } }
        }
      }catch(e){ console.warn('List fiscal years (entries) error', e); }
      return Array.from(years).sort((a,b)=> b-a);
    }

    async function populateFiscalViewSelector(){
      const sel = $('#viewFiscalSelect'); if(!sel) return;
      sel.innerHTML = '';
      const optNow = document.createElement('option'); optNow.value = 'current'; optNow.textContent = 'Ø§Ù„Ø­Ø§Ù„ÙŠØ©'; sel.appendChild(optNow);
      if (!currentBankId) return;
      const years = await listFiscalYears(currentBankId);
      for(const y of years){ const o=document.createElement('option'); o.value=String(y); o.textContent=`${y}/${y+1}`; sel.appendChild(o); }
    }

    async function recalcOpeningForNextFY(fy){
      if (!currentBankId) return;
      const start = fiscalStartISO(fy);
      const end = fiscalEndISO(fy);
      const totalDebit = await sumEntries(currentBankId, 'debit', start, end);
      const totalCredit = await sumEntries(currentBankId, 'credit', start, end);
      const closing = totalDebit - totalCredit;
      const nextFY = fy + 1;
      const openDate = monthStartISO(nextFY, 7);
      const label = `Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ ${fy}/${nextFY}`;
      if (closing !== 0){ await upsertOpeningBalance(currentBankId, openDate, closing, label); }
    }

    // Pagination and infinite scroll state
    let pagination = {
      debit: { all: [], page: 0, pageSize: 15, loading: false },
      credit: { all: [], page: 0, pageSize: 15, loading: false },
    };

    function getTbodyByType(type){
      return type==='debit' ? $('#debitTableBody') : $('#creditTableBody');
    }

    function resetAndRenderPage(type){
      const p = pagination[type];
      const tbody = getTbodyByType(type);
      const initial = p.all.slice(0, p.pageSize);
      renderRows(tbody, initial);
    }

    function renderMoreRows(type){
      const p = pagination[type];
      const tbody = getTbodyByType(type);
      const start = (p.page + 1) * p.pageSize;
      const end = start + p.pageSize;
      const next = p.all.slice(start, end);
      if(next.length === 0){ return; }
      p.page += 1;
      for(const r of next){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class=\"px-3 py-2 border-2 border-border text-right\">${escapeHtml(r.description||'')}</td>
          <td class=\"px-3 py-2 border-2 border-border text-center\">${r.dateISO}</td>
          <td class=\"px-3 py-2 border-2 border-border text-right\">${r.amountExpr ? `${escapeHtml(r.amountExpr)} = ` : ''}${formatAmount(r.amount)}</td>
          <td class=\"px-3 py-2 border-2 border-border text-right\">${escapeHtml(r.notes||'')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function attachInfiniteScroll(){
      const targets = [
        { type: 'debit', el: $('#debitTableWrap') },
        { type: 'credit', el: $('#creditTableWrap') },
      ];
      for(const t of targets){
        const el = t.el;
        if(!el) continue;
        el.addEventListener('scroll', ()=>{
          const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 8;
          if(nearBottom && !pagination[t.type].loading){
            const p = pagination[t.type];
            if(((p.page + 1) * p.pageSize) < p.all.length){
              p.loading = true;
              try { renderMoreRows(t.type); } finally { p.loading = false; }
            }
          }
        });
      }
    }

    // Populate report month/year selectors
    function initReportMonthYearDefaults(){
      const mSel = $('#reportMonthSelect');
      const yInp = $('#reportYearInput');
      if(!mSel || !yInp) return;
      const now = new Date();
      const currentMonth = now.getMonth() + 1; // 1..12
      const currentYear = now.getFullYear();
      // Build list Jan..Dec (1..12)
      const months = [1,2,3,4,5,6,7,8,9,10,11,12];
      mSel.innerHTML = '';
      for(const m of months){
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'][m-1];
        mSel.appendChild(opt);
      }
      // Set defaults
      mSel.value = String(currentMonth);
      if(!yInp.value) yInp.value = String(currentYear);
    }

    // Monthly export based on report selectors producing single workbook
    async function exportMonthlyFromReportSelectors(){
      if (!currentBankId) { showToast('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const month = Number($('#reportMonthSelect')?.value);
      const year = Number($('#reportYearInput')?.value);
      if(!month || !year){ showToast('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©'); return; }
      // Reuse existing multi-sheet generator but constrained to current bank and single workbook
      try{
        const monthStart = monthStartISO(year, month);
        const monthEnd = monthEndISO(year, month);
        const bankName = currentBankName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const wb = new ExcelJS.Workbook();

        const [debitEntries, creditEntries] = await Promise.all([
          listEntriesByBankAndFilters(currentBankId, 'debit', { fromDateISO: monthStart, toDateISO: monthEnd }),
          listEntriesByBankAndFilters(currentBankId, 'credit', { fromDateISO: monthStart, toDateISO: monthEnd })
        ]);

        const tDebit = debitEntries.reduce((s,e)=> s + Number(e.amount||0), 0);
        const tCredit = creditEntries.reduce((s,e)=> s + Number(e.amount||0), 0);

        const wsD = wb.addWorksheet(`Ù…Ø¯ÙŠÙ† - ${bankName}`);
        let rD = addInfoHeader(wsD, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ù…Ù† ØªØ§Ø±ÙŠØ®', monthStart], ['Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®', monthEnd], ['Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯', debitEntries.length], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', tDebit]]);
        rD += 1;
        addTableWithRtl(wsD, ['Ø§Ù„Ø¨ÙŠØ§Ù†','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], debitEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rD);

        const wsC = wb.addWorksheet(`Ø¯Ø§Ø¦Ù† - ${bankName}`);
        let rC = addInfoHeader(wsC, [['Ø§Ù„Ø¨Ù†Ùƒ', bankName], ['Ù…Ù† ØªØ§Ø±ÙŠØ®', monthStart], ['Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®', monthEnd], ['Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯', creditEntries.length], ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ', tCredit]]);
        rC += 1;
        addTableWithRtl(wsC, ['Ø±Ù‚Ù… Ø´ÙŠÙƒ Ø§Ùˆ Ø±Ù‚Ù… ØªØ­ÙˆÙŠÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø¨Ù„Øº','Ù…Ù„Ø§Ø­Ø¸Ø§Øª'], creditEntries.map(e=> [e.description, e.dateISO, (e.amountExpr ? ('=' + e.amountExpr) : Number(e.amount)), e.notes||'']), rC);

        const buf = await wb.xlsx.writeBuffer();
        const monthName = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'][month-1];
        const fileName = `${bankName} Ø´Ù‡Ø± ${month} (${monthName}) ${year}.xlsx`;
        saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(err){ console.error(err); showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ'); }
    }

    // Annual export (Fiscal: Jul..Jun) across all banks in a single sheet with totals row per bank
    async function exportAnnualSummary(){
      const year = Number($('#reportYearInput')?.value) || (new Date()).getFullYear();
      const fiscalStartYear = (new Date(`${year}-07-01`)).getFullYear();
      try{
        const banks = await listBanks();
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet(`Ù…Ù„Ø®Øµ ${fiscalStartYear}/${fiscalStartYear+1}`);
        let r = addInfoHeader(ws, [["Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©", `${fiscalStartYear}/${fiscalStartYear+1}`]]); r += 1;
        const headers = ['Ø§Ù„Ø¨Ù†Ùƒ','Ø±ØµÙŠØ¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©','Ø§Ù„Ù…Ø¯ÙŠÙ†','Ø§Ù„Ø¯Ø§Ø¦Ù†','Ø§Ù„ØµØ§ÙÙŠ'];
        const rows = [];
        for(const bank of banks){
          const opening = 0; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
          const fromISO = monthStartISO(fiscalStartYear, 7);
          const toISO = monthEndISO(fiscalStartYear+1, 6);
          const d = await sumEntries(bank.id, 'debit', fromISO, toISO);
          const c = await sumEntries(bank.id, 'credit', fromISO, toISO);
          rows.push([bank.name, opening, d, c, d-c]);
        }
        addTableWithRtl(ws, headers, rows, r);
        // set widths
        for(let i=1;i<=headers.length;i++){ ws.getColumn(i).width = 40; }
        const buf = await wb.xlsx.writeBuffer();
        const fileName = `Ù…Ù„Ø®Øµ Ø³Ù†ÙˆÙŠ ${fiscalStartYear}-${fiscalStartYear+1}.xlsx`;
        saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), fileName);
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(err){ console.error(err); showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ'); }
    }

    // Bind report selectors and buttons in init
    function bindReportControls(){
      initReportMonthYearDefaults();
      on('#reportExportMonthlyBtn','click', async (e)=>{ e.preventDefault(); await exportMonthlyFromReportSelectors(); });
      on('#reportExportAnnualBtn','click', async (e)=>{ e.preventDefault(); await exportAnnualSummary(); });
    }
    </script>
</body>
</html>